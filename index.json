[{"content":"æ¼”ç¤ºæ¡ˆä¾‹æ¶æ„å›¾ ä¸­é—´ä»¶æœåŠ¡æ„å»º æ ¹æ®SpringCloudAlibabaä¸SpringCloudçš„å¯¹åº”å…³ç³»,æœ¬æ¬¡æ¡ˆä¾‹å®ç°é‡‡ç”¨ä¸­é—´ä»¶/æ¡†æ¶ç‰ˆæœ¬å¦‚ä¸‹\nSpring Boot: 2.6.13 Spring Cloud: 2021.0.5 Spring Cloud Alibaba: 2021.0.5.0 Nacos: 2.2.0 Seata: 1.6.1 Mysql: 8.1.0 Nacosæ„å»º ä»è¿™é‡Œä¸‹è½½Nacosé¢„ç¼–è¯‘åŒ…,nacosé…ç½®æ•°æ®æˆ‘ä»¬é‡‡ç”¨æŒä¹…åŒ–åˆ°æ•°æ®åº“çš„æ–¹å¼\né¦–å…ˆå‡†å¤‡nacosçš„æ•°æ®åº“å®ä¾‹:\nversion: \u0026#39;3.1\u0026#39; services: nacos: image: mysql:8.1.0 restart: always container_name: mysql_nacos environment: MYSQL_ROOT_PASSWORD: 5566 command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --explicit_defaults_for_timestamp=true --lower_case_table_names=1 ports: - 3306:3306 volumes: - ./config/data/mysql:/var/lib/mysql ç„¶åä¿®æ”¹NacosåŒ…ä¸­çš„schemeå¯¼å…¥åˆ°è¯¥æ•°æ®åº“å®ä¾‹ä¸­\nä¿®æ”¹confç›®å½•ä¸‹çš„application.propertiesæ–‡ä»¶,ä¸»è¦ä¿®æ”¹ä»¥ä¸‹å‡ é¡¹(å•æœºæ¨¡å¼,é›†ç¾¤å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¿®æ”¹):\n#*************** Config Module Related Configurations ***************# ### If use MySQL as datasource: spring.datasource.platform=mysql ### Count of DB: db.num=1 ### Connect URL of DB: db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8\u0026amp;connectTimeout=1000\u0026amp;socketTimeout=3000\u0026amp;autoReconnect=true\u0026amp;useUnicode=true\u0026amp;useSSL=false\u0026amp;serverTimezone=UTC db.user.0=root db.password.0=5566 å¯åŠ¨nacos:\n/Users/fanzhengxiang/data/service/nacos2.2.0/bin/startup.sh -m standalone\nSeataæ„å»º ä»è¿™é‡Œä¸‹è½½seataçš„é¢„ç¼–è¯‘åŒ…,æœ¬æ¬¡å®éªŒseataæ•°æ®åŒæ ·æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­,å‡†å¤‡ä¸€ä¸ªæ•°æ®åº“å®ä¾‹\nversion: \u0026#39;3.1\u0026#39; services: seata_db: image: mysql:8.1.0 restart: always container_name: mysql_seata environment: MYSQL_ROOT_PASSWORD: 5566 command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --explicit_defaults_for_timestamp=true --lower_case_table_names=1 ports: - 3307:3306 volumes: - ./config/data/mysql:/var/lib/mysql å°†mysqlçš„å»ºè¡¨æ•°æ®å¯¼å…¥åˆ°seataçš„æ•°æ®åº“å®ä¾‹ä¸­\nä¿®æ”¹seataçš„å¯åŠ¨é…ç½®æ–‡ä»¶conf/application.yml,ä¸»è¦ä¿®æ”¹configé¡¹,registryé¡¹ç›®,storeé¡¹ç›®,ä»¥ä¸‹æ˜¯å®ä¾‹\næ³¨æ„:ç”±äºmysqlçš„ç‰ˆæœ¬ä¸º8,æ‰€ä»¥é©±åŠ¨è¿æ¥ä¸ºcom.mysql.cj.jdbc.Driver,å¹¶ä¸”éœ€è¦ä¸‹è½½mysql8çš„javaé©±åŠ¨åˆ°seataçš„libæŠ¥ä¸‹\n# Copyright 1999-2019 Seata.io Group. # # Licensed under the Apache License, Version 2.0 (the \u0026#34;License\u0026#34;); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an \u0026#34;AS IS\u0026#34; BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. server: port: 7091 spring: application: name: seata-server logging: config: classpath:logback-spring.xml file: path: ${user.home}/logs/seata # extend: # logstash-appender: # destination: 127.0.0.1:4560 # kafka-appender: # bootstrap-servers: 127.0.0.1:9092 # topic: logback_to_logstash console: user: username: seata password: seata seata: config: # support: nacos ã€ consul ã€ apollo ã€ zk ã€ etcd3 type: nacos nacos: server-addr: 127.0.0.1:8848 namespace: group: SEATA_GROUP username: password: context-path: ##if use MSE Nacos with auth, mutex with username/password attribute #access-key: #secret-key: data-id: seataServer.properties registry: # support: nacos ã€ eureka ã€ redis ã€ zk ã€ consul ã€ etcd3 ã€ sofa type: nacos nacos: application: seata-server server-addr: 127.0.0.1:8848 group: SEATA_GROUP namespace: cluster: default username: password: context-path: ##if use MSE Nacos with auth, mutex with username/password attribute #access-key: #secret-key: store: db: datasource: druid db-type: mysql ## è¿™é‡Œæ³¨æ„mysql8çš„é©±åŠ¨è¿æ¥ä¸ºcom.mysql.cj.jdbc.Driver driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://127.0.0.1:3307/seata?rewriteBatchedStatements=true user: root password: 5566 min-conn: 10 max-conn: 100 global-table: global_table branch-table: branch_table lock-table: lock_table distributed-lock-table: distributed_lock query-limit: 1000 max-wait: 5000 # server: # service-port: 8091 #If not configured, the default is \u0026#39;${server.port} + 1000\u0026#39; security: secretKey: SeataSecretKey0c382ef121d778043159209298fd40bf3850a017 tokenValidityInMilliseconds: 1800000 ignore: urls: /,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/api/v1/auth/login å¯åŠ¨seata: nohup sh bin/seata-server.sh -p 18091 -n 1 \u0026amp;\nnacos: æ³¨å†Œä¿¡æ¯\nseataæ§åˆ¶å°\nä»£ç å‡†å¤‡ æºç åœ¨è¿™é‡ŒæŸ¥çœ‹\nå‡†å¤‡ä¸‰ä¸ªå¾®æœåŠ¡æ¨¡å—çš„æ•°æ®åº“å®ä¾‹\nversion: \u0026#39;3.1\u0026#39; services: seata_order: image: mysql:8.1.0 restart: always container_name: seata_order environment: MYSQL_ROOT_PASSWORD: 5566 command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --explicit_defaults_for_timestamp=true --lower_case_table_names=1 ports: - 3308:3306 volumes: - ./order/config/data/mysql:/var/lib/mysql seata_inventory: image: mysql:8.1.0 restart: always container_name: seata_inventory environment: MYSQL_ROOT_PASSWORD: 5566 command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --explicit_defaults_for_timestamp=true --lower_case_table_names=1 ports: - 3309:3306 volumes: - ./inventory/config/data/mysql:/var/lib/mysql seata_account: image: mysql:8.1.0 restart: always container_name: seata_account environment: MYSQL_ROOT_PASSWORD: 5566 command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --explicit_defaults_for_timestamp=true --lower_case_table_names=1 ports: - 3310:3306 volumes: - ./account/config/data/mysql:/var/lib/mysql é¡¹ç›®ä¾èµ–:\n\u0026lt;properties\u0026gt; \u0026lt;maven.compiler.target\u0026gt;8\u0026lt;/maven.compiler.target\u0026gt; \u0026lt;maven.compiler.source\u0026gt;8\u0026lt;/maven.compiler.source\u0026gt; \u0026lt;spring.boot.version\u0026gt;2.6.13\u0026lt;/spring.boot.version\u0026gt; \u0026lt;spring.cloud.version\u0026gt;2021.0.5\u0026lt;/spring.cloud.version\u0026gt; \u0026lt;spring.cloud.alibaba.version\u0026gt;2021.0.5.0\u0026lt;/spring.cloud.alibaba.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.boot.version}\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.cloud.version}\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-alibaba-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.cloud.alibaba.version}\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.18.28\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; ä»¥è®¢å•æœåŠ¡ä¸ºä¾‹\né¡¹ç›®é…ç½®æ–‡ä»¶application.yml\nserver: port: 8081 # ç«¯å£ spring: application: name: order-service datasource: url: jdbc:mysql://127.0.0.1:3308/seata_order?useSSL=false\u0026amp;useUnicode=true\u0026amp;characterEncoding=UTF-8 driver-class-name: com.mysql.cj.jdbc.Driver username: root password: 5566 cloud: nacos: discovery: server-addr: 127.0.0.1:8848 seata: application-id: ${spring.application.name} tx-service-group: ${spring.application.name}-group service: vgroup-mapping: order-service-group: default registry: type: nacos nacos: cluster: default server-addr: localhost namespace: å…¶ä¸­è´¦æˆ·æœåŠ¡å’Œåº“å­˜æœåŠ¡çš„Feignæ¥å£å¦‚ä¸‹\nimport com.aires.feign.dto.AccountReduceBalanceDTO; import org.springframework.cloud.openfeign.FeignClient; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestBody; /** * `account-service` æœåŠ¡çš„ Feign å®¢æˆ·ç«¯ */ @FeignClient(name = \u0026#34;account-service\u0026#34;) public interface AccountServiceFeignClient { @PostMapping(\u0026#34;/account/reduce-balance\u0026#34;) void reduceBalance(@RequestBody AccountReduceBalanceDTO accountReduceBalanceDTO); } import com.aires.feign.dto.ProductReduceStockDTO; import org.springframework.cloud.openfeign.FeignClient; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestBody; /** * `product-service` æœåŠ¡çš„ Feign å®¢æˆ·ç«¯ */ @FeignClient(name = \u0026#34;product-service\u0026#34;) public interface ProductServiceFeignClient { @PostMapping(\u0026#34;/product/reduce-stock\u0026#34;) void reduceStock(@RequestBody ProductReduceStockDTO productReduceStockDTO); } ä¸‹å•çš„æ ¸å¿ƒä¸šåŠ¡ä»£ç \n@Service public class OrderServiceImpl implements OrderService { private Logger logger = LoggerFactory.getLogger(getClass()); @Resource private OrderDao orderDao; @Resource private AccountServiceFeignClient accountService; @Resource private ProductServiceFeignClient productService; @Override @GlobalTransactional public Integer createOrder(Long userId, Long productId, Integer price) { Integer amount = 1; // è´­ä¹°æ•°é‡ï¼Œæš‚æ—¶è®¾ç½®ä¸º 1ã€‚ logger.info(\u0026#34;[createOrder] å½“å‰ XID: {}\u0026#34;, RootContext.getXID()); // æ‰£å‡åº“å­˜ productService.reduceStock(new ProductReduceStockDTO().setProductId(productId).setAmount(amount)); // æ‰£å‡ä½™é¢ accountService.reduceBalance(new AccountReduceBalanceDTO().setUserId(userId).setPrice(price)); // ä¿å­˜è®¢å• OrderDO order = new OrderDO().setUserId(userId).setProductId(productId).setPayAmount(amount * price); orderDao.saveOrder(order); logger.info(\u0026#34;[createOrder] ä¿å­˜è®¢å•: {}\u0026#34;, order.getId()); // è¿”å›è®¢å•ç¼–å· return order.getId(); } } åˆ†å¸ƒå¼äº‹åŠ¡æ¼”ç¤º // TODO\n","permalink":"https://www.atomicbot.cloud/posts/tech/seata_at%E6%A8%A1%E5%BC%8F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AE%9E%E8%B7%B5/","summary":"æ¼”ç¤ºæ¡ˆä¾‹æ¶æ„å›¾ ä¸­é—´ä»¶æœåŠ¡æ„å»º æ ¹æ®SpringCloudAlibabaä¸SpringCloudçš„å¯¹åº”å…³ç³»,æœ¬æ¬¡æ¡ˆä¾‹å®ç°é‡‡ç”¨ä¸­é—´ä»¶/æ¡†æ¶ç‰ˆæœ¬å¦‚ä¸‹ Spring Boot: 2.6.13 Spring Cloud: 2021.0.5 Spring Cloud Alibaba: 2021.0.5.0 Nacos: 2.2.0 Seata: 1.6.1 Mysql: 8.1.0 Nacosæ„å»º ä»è¿™é‡Œä¸‹è½½Nacosé¢„ç¼–è¯‘åŒ…,nacosé…ç½®æ•°æ®æˆ‘ä»¬é‡‡ç”¨æŒä¹…åŒ–åˆ°æ•°æ®åº“çš„æ–¹å¼ é¦–å…ˆå‡†å¤‡nacos","title":"Spring Cloud Feign \u0026\u0026 Seata Atæ¨¡å¼åˆ†å¸ƒå¼äº‹åŠ¡å®è·µ"},{"content":"Spring Cloud Feign åœ¨å¼‚æ­¥æ¥å£æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼ é€’è¯·æ±‚å¤´Token ä¸šåŠ¡æµç¨‹ ç”¨æˆ·å‘èµ·è¯·æ±‚å,åœ¨AæœåŠ¡ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘,æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦è°ƒç”¨å…¶ä»–å¾®æœåŠ¡Bè¿›è¡Œæµç¨‹å®¡æ‰¹,ç®€å•æ–¹å¼æ˜¯åœ¨AæœåŠ¡ä¸­æ‰€æœ‰é€»è¾‘(1,2,3)é‡‡ç”¨åŒæ­¥é€»è¾‘æ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­,ä½†æ˜¯å¦‚æœè°ƒç”¨BæœåŠ¡çš„è¿‡ç¨‹ä¸­,å¤„ç†é€»è¾‘å¾ˆå¤æ‚,ä¼šå¯¼è‡´AæœåŠ¡çš„è¯·æ±‚ä¸€ç›´é˜»å¡,ç”¨æˆ·ä½“éªŒå¾ˆä¸å¥½\nä¼˜åŒ–åçš„é€»è¾‘ä¸ºå°†ç¬¬2æ­¥,è°ƒæ•´ä¸ºå¼‚æ­¥é€»è¾‘,å¼‚æ­¥è°ƒç”¨æœåŠ¡B,å¯ä»¥ä½¿AæœåŠ¡å¿«é€Ÿå®Œæˆé€»è¾‘å¤„ç†,ç›¸åº”ç”¨æˆ·,BæœåŠ¡åœ¨æµç¨‹å‘èµ·æˆåŠŸä¹‹å,å†å›è°ƒAæœåŠ¡,å›å†™æµç¨‹å‘èµ·çš„ç»“æœ(æµç¨‹å‘èµ·æˆåŠŸæˆ–è€…æµç¨‹å‘èµ·å¤±è´¥çš„åŸå› ),æ­¤æ—¶å°±å¼•ç”³å‡ºä¸€ä¸ªé—®é¢˜: åœ¨å¼‚æ­¥è°ƒç”¨æ—¶,feignæ¥å£çš„è¯·æ±‚ä¼šä¸¢å¤±æ‰è¯·æ±‚å¤´ä¸­çš„Token,å¯¼è‡´åœ¨è°ƒç”¨æœåŠ¡Bæ—¶å‡ºç°401\nè§£å†³æ–¹æ¡ˆ ç½‘ä¸Šå¤§å¤šæ•°çš„è§£å†³åŠæ³•éƒ½æ˜¯æŠ„æ¥æŠ„å»ä½¿ç”¨æ‹¦æˆªå™¨æ–¹å¼å®ç°,ä¸æ¨è,æˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯Feignå®˜æ–¹çš„è§£å†³æ–¹æ¡ˆ,Feign Builder\næ‰‹åŠ¨åˆ›å»ºFeign Client\nå®é™…æ“ä½œ å¾®æœåŠ¡Bç°æœ‰çš„Feignæ¥å£å¦‚ä¸‹:\n@FeignClient( name = \u0026#34;eip-bpm-runtime\u0026#34;, url = \u0026#34;${eip-bpm-runtime:}\u0026#34;, fallbackFactory = FlowApiFallback.class ) public interface FlowApi { @RequestMapping( value = {\u0026#34;/flow/instance/v1/start\u0026#34;}, method = {RequestMethod.POST}, produces = {\u0026#34;application/json; charset=utf-8\u0026#34;} ) ObjectNode start(@RequestBody JSONObject var1) throws Exception; } ç°åœ¨éœ€è¦åœ¨AæœåŠ¡ä¸­æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªFlowApiçš„å®ä¾‹å‘èµ·è°ƒç”¨\né¦–å…ˆåœ¨AæœåŠ¡ä¸­åˆ›å»ºä¸€ä¸ªé…ç½®ç±»\nimport com.aliyun.openservices.shade.com.alibaba.fastjson.support.spring.FastJsonJsonView; import com.fasterxml.jackson.databind.ObjectMapper; import com.hotent.api.FlowApi; import feign.Client; import feign.Feign; import org.apache.http.HttpHeaders; import org.springframework.beans.factory.ObjectFactory; import org.springframework.boot.autoconfigure.http.HttpMessageConverters; import org.springframework.cloud.openfeign.support.SpringDecoder; import org.springframework.cloud.openfeign.support.SpringEncoder; import org.springframework.cloud.openfeign.support.SpringMvcContract; import org.springframework.http.converter.HttpMessageConverter; import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter; import org.springframework.stereotype.Component; import javax.annotation.Resource; /** * BPM å¼‚æ­¥feignè¯·æ±‚å¤´è®¾ç½® * * @author kiki * @date 2022/1/13 14:25 * @since 0.0.1 */ @Component public class BpmFlowApiConfig { @Resource private Client client; /** * æ¥å£è¯·æ±‚path */ private String url; public void setUrl(String url) { this.url = url; } public FlowApi flowApiClient(String accessToken){ HttpMessageConverter jsonConverter = new MappingJackson2HttpMessageConverter(new ObjectMapper()); ObjectFactory\u0026lt;HttpMessageConverters\u0026gt; converter = () -\u0026gt; new HttpMessageConverters(jsonConverter); return Feign.builder().client(client) .encoder(new SpringEncoder(converter)) .decoder(new SpringDecoder(converter)) .contract(new SpringMvcContract()) .requestInterceptor(template -\u0026gt; template.header(org.springframework.http.HttpHeaders.AUTHORIZATION, accessToken)) .requestInterceptor(template -\u0026gt; template.header(HttpHeaders.CONTENT_TYPE, FastJsonJsonView.DEFAULT_CONTENT_TYPE)) .target(FlowApi.class, url); } } ç„¶ååœ¨éœ€è¦å‘èµ·å¯¹BæœåŠ¡è°ƒç”¨çš„åœ°æ–¹æ³¨å…¥è¯¥é…ç½®ç±»,å¹¶æ‰‹åŠ¨æ„å»ºFeignå®¢æˆ·ç«¯å‘èµ·è°ƒç”¨\n/** * desc * * @author kiki * @date 2022/1/13 11:37 * @since 0.0.1 */ @Service @Slf4j public class IAsyncServiceImpl implements IAsyncService { /** * ç›®æ ‡å¾®æœåŠ¡çš„æœåŠ¡åç§° * */ @Value(\u0026#34;${bpm.url:http://eip-bpm-runtime/}\u0026#34;) private String flowApiUrl; @Resource private BpmFlowApiConfig bpmFlowApiConfig; /** * å¼‚æ­¥ä¸Šä¼ å‘ç¥¨å¹¶å‘èµ·å®¡æ‰¹ * * @param paymentAddEo è¯·æ±‚å‚æ•° * @param header ä¸Šæ¸¸è¯·æ±‚çš„Token */ @Async @Override public void uploadInvoicesAndStartBpmProcess(PaymentBillAddReqDto paymentAddEo, String header) { // TODO AæœåŠ¡çš„è‡ªèº«ä¸šåŠ¡é€»è¾‘... startNewBpmProcess(paymentAddEo, fileIdList, header); // TODO AæœåŠ¡çš„è‡ªèº«åç»­ä¸šåŠ¡é€»è¾‘... } private void startNewBpmProcess(PaymentBillAddReqDto paymentAddEo, List\u0026lt;String\u0026gt; fileIdList, String header) { try { // ...çœç•¥ä¸šåŠ¡é€»è¾‘ log.info(\u0026#34;{}å‘èµ·bpmç”³è¯·æµç¨‹å‚æ•°ï¼š{}\u0026#34;, paymentBillDesc, paramStr); // è¿™é‡Œæ˜¯å‘èµ·è°ƒç”¨é…ç½®çš„å…³é”® // 1.è®¾ç½®è°ƒç”¨æœåŠ¡çš„æœåŠ¡å // 2.æ‰‹åŠ¨ä¸ºFeign Clientè®¾ç½®header(token) bpmFlowApiConfig.setUrl(flowApiUrl); start = bpmFlowApiConfig.flowApiClient(header).start(JSON.parseObject(paramStr)); ObjectMapper objectMapper = new ObjectMapper(); String resultStr = objectMapper.writeValueAsString(start); log.info(\u0026#34;{}å‘èµ·BPMå®¡æ‰¹è¯·æ±‚ç»“æœï¼š{}\u0026#34;, paymentBillDesc, resultStr); // ...çœç•¥ä¸šåŠ¡é€»è¾‘ bpmProcessService.add(reqDto); } catch (Exception e) { log.error(\u0026#34;{}å¤±è´¥ï¼Œbpmè¿”å›ä¿¡æ¯{}ï¼Œä¿å­˜çš„æµç¨‹ä¿¡æ¯{}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š{}\u0026#34;, paymentBillDesc, JSON.toJSONString(start), JSONObject.toJSONString(paymentAddEo, SerializerFeature.PrettyFormat), e); throw new BizException(String.format(\u0026#34;%så‘èµ·BPMå®¡æ‰¹å¤±è´¥ï¼\u0026#34;, e.getMessage())); } } } å…¶ä¸­,AæœåŠ¡åœ¨è¯·æ±‚å‘èµ·æ—¶,ä¼ é€’çš„Tokenéœ€è¦åœ¨AæœåŠ¡å‘èµ·è°ƒç”¨å‰äº‹å…ˆè·å–\nServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes(); HttpServletRequest request = requestAttributes.getRequest(); String accessToken = request.getHeader(\u0026#34;Access-Token\u0026#34;); ","permalink":"https://www.atomicbot.cloud/posts/tech/springcloudfeign%E5%9C%A8%E5%BC%82%E6%AD%A5%E6%8E%A5%E5%8F%A3%E6%89%A7%E8%A1%8C%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BC%A0%E9%80%92%E8%AF%B7%E6%B1%82%E5%A4%B4token/","summary":"Spring Cloud Feign åœ¨å¼‚æ­¥æ¥å£æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼ é€’è¯·æ±‚å¤´Token ä¸šåŠ¡æµç¨‹ ç”¨æˆ·å‘èµ·è¯·æ±‚å,åœ¨AæœåŠ¡ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘,æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦è°ƒç”¨å…¶ä»–å¾®æœåŠ¡Bè¿›è¡Œæµç¨‹å®¡æ‰¹,ç®€å•æ–¹å¼æ˜¯åœ¨AæœåŠ¡ä¸­æ‰€æœ‰é€»è¾‘(1,2,3)é‡‡ç”¨åŒæ­¥é€»è¾‘æ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­,ä½†æ˜¯å¦‚æœè°ƒç”¨BæœåŠ¡çš„è¿‡ç¨‹ä¸­,å¤„ç†é€»è¾‘å¾ˆå¤æ‚,ä¼šå¯¼è‡´AæœåŠ¡çš„è¯·æ±‚ä¸€ç›´é˜»å¡","title":"Spring Cloud Feignåœ¨å¼‚æ­¥æ¥å£æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼ é€’è¯·æ±‚å¤´Token"},{"content":" ğŸ”–ğŸ”– 211éç§‘ç­ç¨‹åºå‘˜,è‡ªå­¦ç¼–ç¨‹æ··å£é¥­åƒ,åæ ‡æˆéƒ½,åœ¨æŸä¸­å¤§å‹é£Ÿå“å…¬å¸ä»»Javaå¼€å‘å·¥ç¨‹å¸ˆä¸€æšã€‚\nä¸»è¦æŠ€æœ¯æ ˆæ¶‰çŒæœ‰ä»¥ä¸‹: ğŸ’¥ Javaæ ¸å¿ƒ ğŸ’¥ Spring Boot Spring Cloudç”Ÿæ€ ğŸ’¥ Springç”Ÿæ€å¸¸ç”¨ä¸”æˆç†Ÿçš„ä¸­é—´ä»¶ ğŸš€ Vue2+Vue3 (å­¦ä¹ ä¸­,æš‚æ—¶è¿˜å·®ç‚¹ç«å€™) âš¡ï¸ Mysqlæ•°æ®åº“ä¸LinuxæœåŠ¡å™¨ ğŸš€ CI/CD,æŒç»­é›†æˆ ğŸ’¥ å¾®æœåŠ¡é›†ç¾¤+k8så®¹å™¨ç”Ÿæ€ ğŸ™ˆ Flutter App å¼€å‘\u0026hellip;(å­¦ä¹ ä¸­) \u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip; ç®€å•å…ˆå†™è¿™äº›,ä¸ªäººé¡¹ç›®åç»­å®Œå–„ ğŸ‰ ğŸ‰ ğŸ‰\n","permalink":"https://www.atomicbot.cloud/about/","summary":"ğŸ”–ğŸ”– 211éç§‘ç­ç¨‹åºå‘˜,è‡ªå­¦ç¼–ç¨‹æ··å£é¥­åƒ,åæ ‡æˆéƒ½,åœ¨æŸä¸­å¤§å‹é£Ÿå“å…¬å¸ä»»Javaå¼€å‘å·¥ç¨‹å¸ˆä¸€æšã€‚ ä¸»è¦æŠ€æœ¯æ ˆæ¶‰çŒæœ‰ä»¥ä¸‹: ğŸ’¥ Javaæ ¸å¿ƒ ğŸ’¥ Spring Boot Spring Cloudç”Ÿæ€ ğŸ’¥ Springç”Ÿæ€å¸¸ç”¨ä¸”æˆç†Ÿçš„ä¸­é—´ä»¶ ğŸš€ Vue2+Vue3 (å­¦ä¹ ä¸­,æš‚æ—¶è¿˜å·®ç‚¹ç«å€™) âš¡ï¸ Mysqlæ•°æ®åº“ä¸LinuxæœåŠ¡å™¨ ğŸš€ CI/CD,æŒç»­é›†æˆ","title":"æˆ‘çš„ä¸€äº›ä¿¡æ¯ğŸ‰ğŸ‰ğŸ‰ "},{"content":"èƒŒæ™¯ Redisçš„ä¸»ä»ã€å“¨å…µè¿™2ä¸­é«˜å¯ç”¨æ¨¡å¼å·²ç»è§£å†³äº†Rediså®ä¾‹å‘ç”Ÿæ•…éšœæ—¶çš„è‡ªåŠ¨ä¸»å¤‡åˆ‡æ¢,ä¿è¯äº†æœåŠ¡çš„é«˜å¯ç”¨\nä½†æ˜¯è¿™åªæ˜¯è§£å†³äº†æœåŠ¡çš„å¯é æ€§,éšç€ä¸šåŠ¡ä¸æ–­å¢é•¿,å¹¶å‘é‡æå‡,åŸæœ‰çš„ä¸»ä»æ¶æ„å·²ç»æ— æ³•æ»¡è¶³æ€§èƒ½è¦æ±‚äº†,è¿™æ—¶ä¼šå‡ºç°ä¸€äº›é—®é¢˜:\nå•æœºçš„ç‰©ç†æ€§èƒ½è¾¾åˆ°æé™,ä¸èƒ½æ— é™æ‰¿å—æµé‡å¢åŠ  è¶…é¢è¯·æ±‚ã€å¤§è§„æ¨¡æ•°æ®è®¡ç®—å¯¼è‡´è¯·æ±‚å“åº”ç¼“æ…¢ Clusteræ¨¡å¼ä»‹ç» Clusterå³é›†ç¾¤æ¨¡å¼,ç±»ä¼¼Mysql,Redisé›†ç¾¤ä¹Ÿæ˜¯ä¸€ç§åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆ,é›†ç¾¤é€šè¿‡åˆ†ç‰‡æ¨¡å¼æ¥å¯¹æ•°æ®è¿›è¡Œç®¡ç†,å¹¶ä¸”å…·å¤‡äº†åˆ†ç‰‡é—´æ•°æ®å¤åˆ¶ã€æ•…éšœè½¬ç§»å’Œæµé‡è°ƒåº¦çš„èƒ½åŠ›.\nRedisé›†ç¾¤çš„åšæ³•æ˜¯:å°†æ•°æ®åˆ’åˆ†ä¸º16384(2çš„14æ¬¡æ–¹)å’Œå“ˆå¸Œæ§½(slots),å¦‚æœæœ‰å¤šä¸ªå®ä¾‹èŠ‚ç‚¹,é‚£ä¹ˆæ¯ä¸ªå®ä¾‹èŠ‚ç‚¹ç®¡ç†å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ§½ä½,æ§½ä½çš„ä¿¡æ¯å›å­˜å‚¨åœ¨å„è‡ªå½’å±çš„èŠ‚ç‚¹ä¸­,æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£é›†ç¾¤ä¸­çš„ä¸€éƒ¨åˆ†æ•°æ®,æ•°æ®é‡å¯ä»¥ä¸å‡åŒ€,æ¯”å¦‚æ€§èƒ½å¥½çš„èŠ‚ç‚¹å¯ä»¥å¤šåˆ†æ‘Šä¸€äº›å‹åŠ›\nRedisé›†ç¾¤æœ‰16384ä¸ªå“ˆå¸Œæ§½,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨1-nä¸ªèŠ‚ç‚¹æ¥åˆ†é…è¿™äº›å“ˆå¸Œæ§½,å¹¶ä¸”å¯ä»¥ä¸å‡åŒ€åˆ†é…,æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå¤„ç†0-16384ä¸ªå“ˆå¸Œæ§½,å½“å…¨éƒ¨16384ä¸ªå“ˆå¸Œæ§½éƒ½æœ‰å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œç®¡ç†æ—¶,é›†ç¾¤å¤„äºonlineçŠ¶æ€,å¦‚æœæœ‰ä»»ä¸€ä¸€ä¸ªå“ˆå¸Œæ§½æ²¡æœ‰è¢«ç®¡ç†åˆ°,é‚£ä¹ˆé›†ç¾¤å¤„äºofflineçŠ¶æ€\né›†ç¾¤èŠ‚ç‚¹ä¹‹é—´é€šè¿‡gossipåè®®è¿›è¡Œäº¤äº’,è¿™æ ·æ¯ä¸ªèŠ‚ç‚¹é™¤äº†æœ‰è‡ªèº«å“ˆå¸Œæ§½çš„åˆ†é…æƒ…å†µäº†,ä¹Ÿèƒ½çŸ¥é“å…¶ä»–èŠ‚ç‚¹çš„å“ˆå¸Œæ§½åˆ†é…æƒ…å†µ\nä¸ºä»€ä¹ˆéœ€è¦Clusteræ¨¡å¼ å½“å•æœºçš„ååé‡æ— æ³•æ‰¿å—æŒç»­å¢åŠ çš„æµé‡æ—¶,æœ€å¥½çš„åŠæ³•æ˜¯æ¨ªå‘å’Œçºµå‘è¿›è¡Œæ‰©å±•\nçºµå‘æ‰©å±•: æå‡å®ä¾‹çš„ç¡¬ä»¶èµ„æº,ä¾‹å¦‚CPUã€å†…å­˜ã€SSD æ¨ªå‘æ‰©å±•:æ¨ªå‘å¢åŠ Redisçš„å®ä¾‹æ•°é‡,è¿™æ ·ä¾¿å¯ä»¥é™ä½æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£çš„å“ˆå¸Œæ§½æ•°é‡,å…¸å‹çš„åˆ†æ²»æ€ç»´ çºµå‘å’Œæ¨ªå‘æ‰©å±•çš„ä¼˜ç¼ºç‚¹:\nçºµå‘æ‰©å±•æ¯”è¾ƒç®€å•,ä½†æ˜¯å•æœºç‰©ç†æ€§èƒ½ä¸èƒ½æ— é™æ‰©å±•,å•æœºä¹Ÿæ— æ³•è§£å†³ä¸€äº›ç“¶é¢ˆé—®é¢˜,ä¾‹å¦‚å¤§æ•°æ®é‡çš„æŒä¹…åŒ–(RDBå’ŒAOF) æ¨ªå‘æ‰©å±•ä¹Ÿæ¯”è¾ƒå®¹æ˜“,ä½†æ˜¯æ¨ªå‘åˆ†ç‰‡ä¼šå¸¦æ¥æ›´å¤šçš„é—®é¢˜,æ–°å¢èŠ‚ç‚¹å,å“ˆå¸Œæ§½å¦‚ä½•é‡æ–°åˆ†é…,èŠ‚ç‚¹é—´çš„æ•°æ®å¦‚ä½•é‡æ–°åˆ†é… Clusterå®ç°åŸç† é›†ç¾¤ç»„æˆè¿‡ç¨‹ é›†ç¾¤æ˜¯ç”±ä¸€ä¸ªä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹æ‰€ç»„æˆçš„,æ‰€ä»¥åˆšå¼€å§‹çš„æ—¶å€™,å®ƒä»¬ä¹‹é—´æ˜¯æ²¡æœ‰ä»»ä½•å…³ç³»çš„,å„ä¸ªèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ CLUSTER MEET \u0026lt;ip\u0026gt; \u0026lt;port\u0026gt;å‘½ä»¤å®Œæˆé›†ç¾¤ç»„å»º,å…·ä½“åšæ³•æ˜¯:å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å‘å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹å‘é€CLUSTER MEETå‘½ä»¤,è¿™æ ·2ä¸ªèŠ‚ç‚¹å°±å¯ä»¥è¿›è¡Œæ¡æ‰‹,æ¡æ‰‹æˆåŠŸä¹‹å,èŠ‚ç‚¹å°±ä¼šå°†å¦ä¸€ä¾§æ¡æ‰‹çš„èŠ‚ç‚¹æ·»åŠ åˆ°å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤ä¸­\né›†ç¾¤æ•°æ®åˆ†ç‰‡åŸç† ç°åœ¨ä¸»æµçš„Redisé›†ç¾¤åˆ†ç‰‡åšæ³•ä¸»è¦æ˜¯ä½¿ç”¨å®˜æ–¹çš„Redisé›†ç¾¤æ–¹æ¡ˆ.è¿™ç§æ–¹æ¡ˆçš„æ ¸å¿ƒå°±æ˜¯é›†ç¾¤èŠ‚ç‚¹ä¸å“ˆå¸Œæ§½ä¹‹é—´çš„åˆ’åˆ†ã€ç®¡ç†ä¸æ˜ å°„\nå“ˆå¸Œæ§½çš„åˆ’åˆ† å‰é¢è¯´è¿‡,æ•´ä¸ªRedisé›†ç¾¤ä¼šåˆ’åˆ†16384ä¸ªslots,é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ç“œåˆ†è¿™äº›å“ˆå¸Œæ§½,è€Œä½ å…·ä½“å­˜å‚¨çš„æŸä¸ªé”®å€¼ä¿¡æ¯å¿…ç„¶ä¹Ÿå±äºè¿™16384ä¸ªslotsä¸­çš„æŸä¸€ä¸ª,Redis Keyä¸slotsçš„æ˜ å°„æ­¥éª¤å¦‚ä¸‹:\nä½¿ç”¨CRC16ç®—æ³•è®¡ç®—é”®å€¼å¯¹çš„key,å¾—åˆ°ä¸€ä¸ª16bitçš„å€¼ å°†è¿™ä¸ª16bitçš„å€¼å¯¹16384å–æ¨¡,å¾—åˆ°å°±æ˜¯å…·ä½“çš„å“ˆå¸Œæ§½çš„ä½ç½®,å½“ç„¶ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹,ä¹Ÿå¯ä»¥å°†æŸäº›keyå›ºå®šåˆ°æŸä¸ªslotsä¸Š,ä¹Ÿå°±æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š,è¿™æ—¶éœ€è¦ä½¿ç”¨hash tagèƒ½åŠ›,å¼ºåˆ¶æŸä¸ªkeyæ‰€å½’å±çš„slotsæ§½ä½,ä½¿ç”¨æ–¹å¼æ˜¯åœ¨keyä¸Šé¢åŠ ä¸€ä¸ª{} 127.0.0.1:6380\u0026gt; cluster keyslot user:case{1} (integer) 1024 127.0.0.1:6380\u0026gt; cluster keyslot user:favor (integer) 1023 127.0.0.1:6380\u0026gt; cluster keyslot user:info{1} (integer) 1024 å®ä¾‹ä¸­,æ‰€æœ‰ä½¿ç”¨äº†hash tagçš„é”®å€¼å¯¹éƒ½è¢«å­˜æ”¾åˆ°äº†åŒä¸€ä¸ªå“ˆå¸Œæ§½ä¸­\nå“ˆå¸Œæ§½çš„æ˜ å°„ é¦–å…ˆæ˜¯é›†ç¾¤åˆå§‹åŒ–çš„æ—¶å€™å‡åŒ€åˆ†é…,ä½¿ç”¨CLUSTER CREATE,ä¼šå°†16384ä¸ªslotså¹³å‡åˆ†é…åˆ°æ‰€æœ‰å®ä¾‹ä¸Š.å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨CLUSTER MEETå‘½ä»¤,å°†æ‰€æœ‰èŠ‚ç‚¹è”é€šæˆä¸€ä¸ªé›†ç¾¤,åˆšè”é€šçš„æ—¶å€™ç”±äºè¿˜æ²¡æœ‰åˆ†é…å“ˆå¸Œæ§½,æ­¤æ—¶é›†ç¾¤å¤„äºofflineçŠ¶æ€,å¯ä»¥ä½¿ç”¨cluster addslotsæ¥åˆ†é…å“ˆå¸Œæ§½.\næ¯”å¦‚å®ä¾‹1ç®¡ç†0-7120å“ˆå¸Œæ§½,å®ä¾‹2ç®¡ç†7121-9945å“ˆå¸Œæ§½,å®ä¾‹3ç®¡ç†9946-13005å“ˆå¸Œæ§½,å®ä¾‹4ç®¡ç†13006-16383å“ˆå¸Œæ§½\nredis-cli -h 192.168.0.1 â€“p 6379 cluster addslots 0,7120 redis-cli -h 192.168.0.2 â€“p 6379 cluster addslots 7121,9945 redis-cli -h 192.168.0.3 â€“p 6379 cluster addslots 9946,13005 redis-cli -h 192.168.0.4 â€“p 6379 cluster addslots 13006,16383 æ•°æ®å¤åˆ¶è¿‡ç¨‹å’Œæ•…éšœè½¬ç§» æ•°æ®å¤åˆ¶ clusteræ˜¯å…·å¤‡masterå’Œslaveçš„,æ¯ä¸ªå®ä¾‹èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ä½,æ¯ä¸ªmasterè‡³å°‘éœ€è¦ä¸€ä¸ªslaveèŠ‚ç‚¹,slaveé€šè¿‡ä¸»ä»æ¶æ„æ¨¡å¼åŒæ­¥ä¸»èŠ‚ç‚¹æ•°æ®,èŠ‚ç‚¹ä¹‹é—´ä¿æŒTCPé€šä¿¡,å½“masterå‘ç”Ÿå®•æœºæ—¶,Redis clusterä¼šè‡ªåŠ¨å°†å¯¹åº”çš„slaveèŠ‚ç‚¹æå‡ä¸ºmasteræ¥ç»§ç»­æä¾›æœåŠ¡,ä¸çº¯ä¸»ä»æ¨¡å¼ä¸åŒçš„æ˜¯,ä¸»ä»èŠ‚ç‚¹ä¹‹é—´æ²¡æœ‰è¯»å†™åˆ†ç¦»,slaveåªæ˜¯ä½œä¸ºmasterçš„é«˜å¯ç”¨å¤‡ä»½èŠ‚ç‚¹.\nå¦‚æœä¸»èŠ‚ç‚¹æ²¡æœ‰ä»èŠ‚ç‚¹,é‚£ä¹ˆmasterä¸€æ—¦å‘ç”Ÿæ•…éšœ,é›†ç¾¤å°±ä¼šå¤„äºå®Œå…¨ä¸å¯ç”¨çŠ¶æ€,ä½†ä¹Ÿå…è®¸é…ç½®cluster-require-full-coverageå‚æ•°,å³ä½¿éƒ¨åˆ†èŠ‚ç‚¹ä¸å¯ç”¨,å…¶ä»–èŠ‚ç‚¹ä¹Ÿèƒ½æ­£å¸¸æä¾›æœåŠ¡,ä¸»ä»åˆ‡æ¢ä¹‹å,æ•…éšœæ¢å¤çš„ä¸»èŠ‚ç‚¹,ä¼šè½¬åŒ–ä¸ºæ–°çš„ä»èŠ‚ç‚¹\næ•…éšœæ£€æµ‹ ä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºæŸä¸ªèŠ‚ç‚¹å®•æœºä¸èƒ½è¯´æ˜è¯¥èŠ‚ç‚¹çœŸçš„ä¸å¯ç”¨äº†,åªæœ‰å æ®å¤šæ•°çš„å®ä¾‹è®¤ä¸ºæŸä¸ªèŠ‚ç‚¹æŒ‚äº†,è¿™ä¸ªæ—¶å€™,é›†ç¾¤æ‰è¿›è¡Œä¸‹çº¿å’Œä¸»ä»åˆ‡æ¢çš„å·¥ä½œ\nRedisé›†ç¾¤çš„èŠ‚ç‚¹é‡‡ç”¨gossipåè®®æ¥å¹¿æ’­ä¿¡æ¯,æ¯ä¸ªèŠ‚ç‚¹ä¼šå®šæœŸå‘å…¶ä»–èŠ‚ç‚¹å‘é€pingå‘½ä»¤,å¦‚æœè¢«pingçš„èŠ‚ç‚¹æ²¡æœ‰åœ¨æŒ‡å®šæ—¶é—´å†…æ¢å¤pong,åˆ™è®¤ä¸ºè¯¥èŠ‚ç‚¹å¤±è”,å‘é€pingå‘½ä»¤çš„èŠ‚ç‚¹å°†å¯¹æ–¹æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿,å¦‚æœåŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹éƒ½å°†æŸä¸ªèŠ‚ç‚¹æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿,åˆ™è¿™ä¸ªèŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿,ç„¶åå‘æ•´ä¸ªé›†ç¾¤å¹¿æ’­,å¹¶å¯¹ä¸‹çº¿çš„èŠ‚ç‚¹è¿›è¡Œä¸»ä»åˆ‡æ¢\nä¸»ä»æ•…éšœè½¬ç§» å½“æŸä¸ªä»èŠ‚ç‚¹å‘ç°è‡ªå·±slaveofçš„ä¸»èŠ‚ç‚¹ä¸‹çº¿äº†,åˆ™å¼€å§‹å¯¹ä¸‹çº¿çš„ä¸»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»,æ­¥éª¤å¦‚ä¸‹:\nå¦‚æœåªæœ‰ä¸€ä¸ªslave,é‚£ä¹ˆè¯¥èŠ‚ç‚¹ä¼šæ‰§è¡Œslaveof no one,æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ å¦‚æœå­˜åœ¨å¤šä¸ªslave,åˆ™é‡‡ç”¨é€‰ä¸¾æ¨¡å¼ç«é€‰å‡ºæ–°çš„master é›†ç¾¤ä¸­è®¾ç«‹ä¸€ä¸ªè‡ªå¢çš„è®¡æ•°å™¨,åˆå§‹å€¼ä¸º0,æ¯æ¬¡æ‰§è¡Œæ•…éšœè½¬ç§»é€‰ä¸¾,è®¡æ—¶å™¨+1 æ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹ä¸‹çº¿çš„ä»èŠ‚ç‚¹å‘é›†ç¾¤çš„æ‰€æœ‰masterå¹¿æ’­ä¸€æ¡CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUESTæ¶ˆæ¯,æ‰€æœ‰æ”¶åˆ°æ¶ˆæ¯ã€å¹¶å…·å¤‡æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹éƒ½å‘è¿™ä¸ªä»èŠ‚ç‚¹æŠ•ç¥¨ å¦‚æœæ”¶åˆ°æ¶ˆæ¯çš„ä¸»èŠ‚ç‚¹æŠ•ç¥¨ç»™äº†å½“å‰ä»èŠ‚ç‚¹,åˆ™è¿”å›CLUSTERMSG_TYPE_FAILOVER_AUTH_ACKè¡¨ç¤ºæ”¯æŒ å‚ä¸é€‰ä¸¾çš„æ‰€æœ‰ä»èŠ‚ç‚¹éƒ½ä¼šæ”¶åˆ°CLUSTERMSG_TYPE_FAILOVER_AUTH_ACKæ¶ˆæ¯,å¦‚æœæŸä¸ªä»èŠ‚ç‚¹çš„æ”¶åˆ°çš„é€‰ç¥¨å¤§äºç­‰äºåŠæ•°master,é‚£ä¹ˆè¿™ä¸ªä»èŠ‚ç‚¹å°±è¢«é€‰ä¸¾ä¸ºæ–°çš„master å¦‚æœè¿™ä¸€è½®æ²¡æœ‰äº§ç”Ÿæ–°çš„master,é‚£ä¹ˆè®¡æ•°å™¨+1,å†å‘èµ·ä¸€è½®æŠ•ç¥¨,ç›´åˆ°é€‰å‡ºæ–°çš„master æ–°çš„masterä¼šæ’¤é”€æ‰€æœ‰å¯¹å·²ä¸‹çº¿masterçš„slotsæŒ‡æ´¾,å¹¶å°†è¿™äº›slotsæŒ‡æ´¾ç»™è‡ªå·± æ–°çš„masterå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡pongæ¶ˆæ¯,è¿™æ¡æ¶ˆæ¯å¯ä»¥è®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹çŸ¥é“è¿™ä¸ªèŠ‚ç‚¹å·²ç»ç”±ä»èŠ‚ç‚¹å˜æˆäº†ä¸»èŠ‚ç‚¹,å¹¶ä¸”æ¥ç®¡äº†åŸæœ‰masterçš„æ‰€æœ‰slots è‡³æ­¤,æ•…éšœè½¬ç§»å®Œæˆ Clientè®¿é—®é›†ç¾¤æ•°æ®çš„è¿‡ç¨‹ å®¢æˆ·ç«¯è¿æ¥åˆ°ä»»æ„ä¸€ä¸ªå®ä¾‹,è·å–åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸slotsçš„æ˜ å°„å…³ç³»,å¹¶å°†æ˜ å°„å…³ç³»ç¼“å­˜åˆ°æœ¬åœ° å°†éœ€è¦è®¿é—®çš„keyç»è¿‡CRC16è®¡ç®—å,å†å¯¹16384å–æ¨¡,å¾—åˆ°å¯¹åº”çš„slotsç´¢å¼• æ ¹æ®slotså®šä½åˆ°å…·ä½“çš„å®ä¾‹,ç„¶åå°†è¯·æ±‚å‘é€åˆ°å¯¹åº”å®ä¾‹ä¸Š ","permalink":"https://www.atomicbot.cloud/posts/tech/redis%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B9%8B%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F/","summary":"èƒŒæ™¯ Redisçš„ä¸»ä»ã€å“¨å…µè¿™2ä¸­é«˜å¯ç”¨æ¨¡å¼å·²ç»è§£å†³äº†Rediså®ä¾‹å‘ç”Ÿæ•…éšœæ—¶çš„è‡ªåŠ¨ä¸»å¤‡åˆ‡æ¢,ä¿è¯äº†æœåŠ¡çš„é«˜å¯ç”¨ ä½†æ˜¯è¿™åªæ˜¯è§£å†³äº†æœåŠ¡çš„å¯é æ€§,éšç€ä¸šåŠ¡ä¸æ–­å¢é•¿,å¹¶å‘é‡æå‡,åŸæœ‰çš„ä¸»ä»æ¶æ„å·²ç»æ— æ³•æ»¡è¶³æ€§èƒ½è¦æ±‚äº†,è¿™æ—¶ä¼šå‡ºç°ä¸€äº›é—®é¢˜: å•æœºçš„ç‰©ç†æ€§èƒ½è¾¾åˆ°æé™,ä¸èƒ½æ— é™æ‰¿å—æµé‡å¢åŠ  è¶…é¢è¯·æ±‚","title":"Redisé«˜å¯ç”¨ä¹‹é›†ç¾¤æ¨¡å¼"},{"content":"èƒŒæ™¯ Redisä¸»ä»æ¨¡å¼ç”±äºæ˜¯è¯»å†™åˆ†ç¦»çš„æ¨¡å¼,å¯ä»¥å¤§å¹…æé«˜æ€§èƒ½å’ŒæœåŠ¡çš„å¯ç”¨æ€§,å‡å°‘ç”šè‡³é¿å…RedisæœåŠ¡å‘ç”Ÿå®•æœºçš„å¯èƒ½,ä¸»ä»æ¨¡å¼çš„ä¸»è¦èƒ½åŠ›å¦‚ä¸‹:\næ•…éšœéš”ç¦»å’Œæ¢å¤: æ— è®ºä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹å´©æºƒ,å…¶ä»–èŠ‚ç‚¹ä»ç„¶å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡(ä¸»èŠ‚ç‚¹å´©æºƒæ—¶,æ— æ³•æä¾›å†™æœåŠ¡,éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ä¸»ä») è¯»å†™åˆ†ç¦»:ä¸»èŠ‚ç‚¹è´Ÿè´£å†™æ“ä½œ,ä»èŠ‚ç‚¹æŒ‰ç…§è´Ÿè½½å‡è¡¡çš„æ–¹å¼æä¾›è¯»æœåŠ¡,åˆ†æ‘Šäº†æµé‡å’Œè¯·æ±‚å‹åŠ›(æç«¯ç‰¹æ®Šæƒ…å†µä¹Ÿå¯ä»¥ç›´æ¥ä»ä¸»åº“è¯»å–) é«˜å¯ç”¨ä¿è¯: ä¸»ä»æ¨¡å¼æ˜¯å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼çš„å‰ç½®æ¡ä»¶ ä¸»ä»æ¨¡å¼ä¼¼ä¹å·²ç»æŒºå¥½äº†,ä½†æ˜¯è¿˜å­˜åœ¨ä¸å°‘é—®é¢˜,ä»æœåŠ¡æ•…éšœåˆ°æ‰‹åŠ¨åˆ‡æ¢æ¢å¤,è¿™å¯èƒ½éœ€è¦ä¸€ä¸ªæ¯”è¾ƒé•¿çš„æ—¶é—´,æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨ä¸»ä»çš„åŸºç¡€ä¸Šä¸ºRedisæä¾›æ„ŸçŸ¥æ•…éšœ,åœ¨masteræ•…éšœæ—¶,å°†æŸä¸€ä¸ªå¯ç”¨çš„slaveè‡ªåŠ¨åˆ‡æ¢ä¸ºmaster,å®ç°æ•…éšœè‡ªåŠ¨è½¬ä¹‰\nå“¨å…µæ¨¡å¼ å“¨å…µæ¨¡å¼çš„æ ¸å¿ƒæ˜¯ä¸»ä»æ¨¡å¼çš„æ¼”å˜,åªä¸è¿‡å¯¹äºä¸»ä»æ¨¡å¼çš„ä¸»èŠ‚ç‚¹å´©æºƒå¼•èµ·æ— æ³•å†™å…¥çš„æƒ…å†µ,å¢åŠ äº†æ¢æ´»æœºåˆ¶:ä»æ‰€æœ‰ä»èŠ‚ç‚¹ç«é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹,ç„¶åè‡ªåŠ¨å¥‡å¹»,ç«é€‰æœºåˆ¶çš„å®ç°ä¾èµ–äºç³»ç»Ÿä¸­å¯åŠ¨çš„sentinelè¿›ç¨‹å¯¹å„ä¸ªä¸»ä»èŠ‚ç‚¹çš„ç›‘æ§\nå“¨å…µçš„èŒè´£ æƒ³è®©Rediså®ç°æœåŠ¡æ•…éšœè‡ªåŠ¨åˆ‡æ¢éœ€è¦è€ƒè™‘çš„ç»†èŠ‚æœ‰å¾ˆå¤š:\nåˆ¤æ–­èŠ‚ç‚¹æ•…éšœçš„æ¡ä»¶?èŠ‚ç‚¹å¯èƒ½æ˜¯å‡æ­»æˆ–è€…å“åº”å»¶è¿Ÿ ç«é€‰æœºåˆ¶,é€‰æ‹©é‚£ä¸ªSlaveæˆä¸ºMaster é€‰å‡ºæ–°çš„Masterä¹‹å,å…¶ä»–Slaveéœ€è¦é‡æ–°slaveofæ–°çš„Master,æ¶ˆæ¯æ˜¯å¦‚ä½•é€šçŸ¥å’Œé€šä¿¡çš„ å®˜æ–¹å¯¹å“¨å…µçš„å®šä¹‰:\nå“¨å…µä½œä¸ºä¸€ç§Redisçš„è¿è¡Œæ¨¡å¼,ä¸“æ³¨äºRedisçš„ä¸»ä»å®ä¾‹è¿›è¡ŒçŠ¶æ€ç›‘æ§,å¹¶ä¸”èƒ½å¤Ÿåœ¨ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶é€šè¿‡ä¸€ç³»åˆ—çš„æ“ä½œ,å®ç°æ–°çš„Masterç«é€‰ã€ä¸»ä»åˆ‡æ¢ã€æ•…éšœè½¬ç§»,ç¡®ä¿æ•´ä¸ªRedisæœåŠ¡çš„å¯ç”¨æ€§\nç›‘æ§ å“¨å…µæ¨¡å¼çš„å¯ç”¨,ä¼šåŒæ­¥å¼€å¯ä¸€ä¸ªå«åšsentinelçš„è¿›ç¨‹,sentinelè¿›ç¨‹ä¼šå‘æ‰€æœ‰çš„Masterå’ŒSlaveä»¥åŠå…¶ä»–sentinelè¿›ç¨‹å‘é€å¿ƒè·³(1sä¸€æ¬¡),çœ‹çœ‹æ˜¯å¦æ­£å¸¸è¿”å›å“åº”\nå¦‚æœSlaveæ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”sentinelçš„pingå‘½ä»¤,sentinelä¼šè®¤ä¸ºè¯¥å®ä¾‹ä¸å¯ç”¨,å°†å…¶æ ‡è®°ä¸º:ä¸‹çº¿çŠ¶æ€ åŒç†å¦‚æœmasteråœ¨è§„å®šæ—¶é—´æ²¡æœ‰å“åº”sentinelçš„pingå‘½ä»¤,ä¹Ÿä¼šè¢«åˆ¤å®šä¸ºä¸‹çº¿çŠ¶æ€,åªä¸è¿‡ä¼šå¤šåšä¸€ä¸ªæ“ä½œ,è‡ªåŠ¨è¿›è¡Œmasterçš„åˆ‡æ¢æµç¨‹ pingå‘½ä»¤çš„å›å¤å¯èƒ½æœ‰2ä¸­æƒ…å†µ\næœ‰æ•ˆå›å¤: è¿”å› pong -loading -masterdownçš„ä»»æ„ä¸€ç§ æ— æ•ˆå›å¤: é™¤æœ‰æ•ˆå›å¤å¤–çš„æƒ…å†µæˆ–è€…è¶…æ—¶æ²¡æœ‰ä»»ä½•å›å¤ ä½†æ˜¯sentinelå¯èƒ½å­˜åœ¨è¯¯åˆ¤çš„æƒ…å†µ,æ¯”å¦‚ç½‘ç»œæŠ–åŠ¨ã€masterå‡æ­»ã€ç½‘ç»œå»¶è¿Ÿå¯¼è‡´æŸä¸ªRediså®ä¾‹çŸ­æš‚ä¸å¯ç”¨,åç»­åˆå¿«é€Ÿæ¢å¤äº†,å¦‚æœè¿™ä¸ªæƒ…å†µä¸‹,æˆ‘ä»¬å°†å…¶ä¸»åŠ¨ä¸‹çº¿,å…¶å®æ˜¯å°†æ•´ä¸ªRedisæœåŠ¡çš„å¯ç”¨æ€§é™ä½äº†,æ‰€ä»¥ä¸èƒ½äº§ç”Ÿè¿™ç§è¯¯åˆ¤.ä¸ºäº†ä¿è¯åˆ¤æ–­çš„å¯é æ€§,sentinelå°†å®ä¾‹æ ‡è®°ä¸ºä¸‹çº¿æœ‰2ç§ä¸‹çº¿:\nä¸»è§‚ä¸‹çº¿:å“¨å…µä½¿ç”¨ pingç›‘æµ‹masterå’Œslave,å¦‚æœæ˜¯æ— æ•ˆå›å¤,å“¨å…µå°†å…¶æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿,å¦‚æœæ˜¯slave,ç›´æ¥å°†å…¶ä¸‹çº¿å³å¯,ä½†å¦‚æœæ˜¯masterå°±è¦å°å¿ƒäº†,ä¸€ä¸ªsentinelå¯èƒ½å­˜åœ¨è¯¯åˆ¤,é‚£ä¹ˆå°±é‡‡ç”¨æ‰€æœ‰å“¨å…µå®ä¾‹ä¸€èµ·æ¥åˆ¤æ–­,å°±å¯ä»¥é¿å…æŸä¸ªå“¨å…µè‡ªèº«ç½‘ç»œæƒ…å†µä¸å¥½,å¯¼è‡´è¯¯åˆ¤å°†msaterä¸‹çº¿,åŒæ—¶ç”±æ‰€æœ‰sentinelä¸€èµ·åšå†³ç­–,è¯¯åˆ¤ç‡ä¹Ÿèƒ½é™ä½\nå®¢è§‚ä¸‹çº¿:masteræ˜¯å¦ä¸‹çº¿ä¸æ˜¯æŸä¸€ä¸ªsentinelèƒ½å¤Ÿå†³å®šçš„,éœ€è¦é›†ç¾¤å†…æ‰€æœ‰sentinelä¸€èµ·æŠ•ç¥¨,è¶…è¿‡åŠæ•°çš„sentinelå®ä¾‹éƒ½åˆ¤æ–­äº†masterä¸»è§‚ä¸‹çº¿,è¿™ä¸ªæ—¶å€™æ‰èƒ½å°†masteræ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿,è®¤ä¸ºmasterçœŸçš„æŒ‚äº†,å½“masterè¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿,ç«‹å³å°±ä¼šå¯åŠ¨æ–°masterç«é€‰çš„æµç¨‹\nå¦‚ä½•åŒºåˆ«ä¸»ã€å®¢è§‚ä¸‹çº¿\nä¸»è§‚ä¸‹çº¿æ˜¯sentinelè‡ªå·±è®¤ä¸ºæŸä¸ªèŠ‚ç‚¹offline,è¿™æ—¶è¯¥èŠ‚ç‚¹å¹¶æ²¡æœ‰ä»RedisæœåŠ¡ä¸­ç§»é™¤;å®¢è§‚ä¸‹çº¿æ˜¯è¾¾åˆ°ä¸€å®šæ•°é‡(é€šå¸¸ä¸ºè¶…è¿‡åŠæ•°)çš„å“¨å…µéƒ½è®¤ä¸ºè¯¥èŠ‚ç‚¹offlineäº†,è¿™æ—¶æ±‡é‡‘ä¸€æ­¥è§¦å‘ç¦»çº¿ã€ç«é€‰ç­‰æ“ä½œ\nè¿™é‡Œçš„è¶…è¿‡åŠæ•°çš„å“¨å…µæ˜¯ä¸€ä¸ªæ³•å®šæ•°é‡ Quorum,åœ¨sentinel.confä¸­è¿›è¡Œé…ç½®,è¯¥é…ç½®ä¸»è¦å‘Šè¯‰å“¨å…µéœ€è¦ç›‘å¬çš„ä¸»èŠ‚ç‚¹ä¿¡æ¯:\n# sentinel monitor \u0026lt;master-name\u0026gt; \u0026lt;master-host\u0026gt; \u0026lt;master-port\u0026gt; \u0026lt;quorum\u0026gt; # ä¸¾ä¾‹å¦‚ä¸‹ï¼š sentinel monitor mymaster 127.0.0.1 6379 2 sentinel monitor : è¡¨ç¤ºç›‘æ§ mymaster: ä¸»èŠ‚ç‚¹åç§°,å¯ä»¥è‡ªå®šä¹‰ 127.0.0.1 6379:ä¸»èŠ‚ç‚¹ipä¸ç«¯å£ 2:æ³•å®šæ•°é‡,åªæœ‰å½“2ä¸ªæˆ–è€…è¶…è¿‡2ä¸ªå“¨å…µå®ä¾‹è®¤ä¸ºä¸»èŠ‚ç‚¹ä¸å¯ç”¨æ—¶,æ‰ä¼šå°†masteræ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿çŠ¶æ€,ç„¶åè¿›è¡Œfailoveræ“ä½œ ä¸»ä»åŠ¨æ€åˆ‡æ¢ ä»ä¼—å¤šslaveä¸­é€‰ä¸¾ä¸€ä¸ªæ–°çš„masterä¼šæ¯”è¾ƒä¸¥è°¨,éœ€è¦é€šè¿‡ç­›é€‰+æ€»å’Œè¯„ä¼°çš„æ–¹å¼è¿›è¡Œé€‰ä¸¾\nç­›é€‰ è¿‡æ»¤æ‰ä¸å¥åº·(ä¸‹çº¿æˆ–è€…æ²¡æœ‰å›å¤å“¨å…µping)çš„ä»èŠ‚ç‚¹ è¯„ä¼°è¿™äº›å®ä¾‹çš„å†å²ç½‘ç»œè¿æ¥çŠ¶å†µ,down-after-milliseconds,å¦‚æœåœ¨ä¸€å®šå‘¨æœŸå†…(æ¯”å¦‚24å°æ—¶)è¿™ä¸ªä»åº“ç»å¸¸æ–­è”å¹¶ä¸”è¿˜è¶…è¿‡äº†æŒ‡å®šé˜ˆå€¼(æ¯”å¦‚10æ¬¡),è¿™ç§ä»èŠ‚ç‚¹ä¸äºˆè€ƒè™‘ è¿™æ ·ç­›é€‰åç•™ä¸‹çš„å°±æ˜¯æ¯”è¾ƒå¥åº·çš„å®ä¾‹äº†\nç»¼åˆè¯„ä¼° ç­›é€‰æ‰ä¸å¥åº·çš„å®ä¾‹å,å°±å¯ä»¥å¯¹å‰©ä½™å¥åº·çš„å®ä¾‹è¿›è¡Œç»¼åˆè¯„ä¼°\nslaveä¼˜å…ˆçº§,é€šè¿‡slave-priorityé…ç½®é¡¹åˆ¤æ–­,ä¼˜å…ˆçº§é«˜çš„ä»èŠ‚ç‚¹ä¼˜å…ˆæˆä¸ºmaster,è¯¥é…ç½®åœ¨redis.confä¸­è¿›è¡Œé…ç½® é€‰æ‹©æ•°æ®åç§»é‡å·®è·æœ€å°çš„,å³master_repl_offsetå’Œslave_repl_offsetçš„è¿›åº¦å·®è·,å…¶å®å°±æ˜¯é€‰æ‹©åŒæ­¥è¿›åº¦æœ€é«˜çš„ slave runID,åœ¨ä¼˜å…ˆçº§å’ŒåŒæ­¥è¿›åº¦ç›¸åŒçš„æƒ…å†µä¸‹,é€‰ç”¨runIDæœ€å°çš„,runIDæœ€å°,è¯´æ˜è¯¥å®ä¾‹åˆ›å»ºæ—¶é—´è¶Šæ—©,è¿è¡Œæ—¶é—´è¶Šé•¿,ä¹Ÿå¯ç†è§£ä¸ºå…ˆæ¥ååˆ° è¿™å‡ ä¸ªæ¡ä»¶éƒ½è¯„ä¼°å®Œå,sentinelé›†ç¾¤å°±ä¼šé€‰å‡ºæœ€åˆé€‚çš„slave,å°†å…¶æ¨ä¸¾ä¸ºæ–°çš„master\nä¿¡æ¯é€šçŸ¥ åœ¨é€‰å‡ºæ–°çš„masterä¹‹å,åç»­å®¢æˆ·ç«¯çš„æ‰€æœ‰å†™æ“ä½œéƒ½ä¼šè¿›å…¥è¿™ä¸ªmaster,æ‰€ä»¥éœ€è¦å°½å¿«é€šçŸ¥å…¶ä»–slaveé‡æ–°slaveofåˆ°æ–°çš„masterä¸Š,é‡æ–°å»ºç«‹runIDå’Œslave_repl_offset,æ¥ä¿è¯æ­£å¸¸çš„æ•°æ®æœåŠ¡å’Œä¸»ä»ä¸€è‡´æ€§\nå“¨å…µæ¨¡å¼å®è·µ å“¨å…µæ¨¡å¼æ­å»º(ä¸»ä»+å“¨å…µ) æµ‹è¯•ä¸»ä»åŠŸèƒ½ æµ‹è¯•masterè‡ªåŠ¨æ•…éšœæ¢å¤ å½“å‰ä¸»ä»çŠ¶æ€ä¸º:\n18080: master\n18081: slave1\n18082: slave2\nå°†18080çš„masteråœæœºåè§‚å¯Ÿä¸»ä»æƒ…å†µ:\né‡æ–°å¯åŠ¨åŸæ¥çš„master,æŸ¥çœ‹ä»–çš„ä¸»ä»æƒ…å†µ:\nè‡³æ­¤:å“¨å…µæ¨¡å¼çš„è‡ªåŠ¨ä¸»ä»æ•…éšœåˆ‡æ¢å®è·µå®Œæ¯•\nå…³äºå“¨å…µé›†ç¾¤ å“¨å…µé›†ç¾¤å¦‚ä½•é€šä¿¡ ä½¿ç”¨redisçš„pub/subè®¢é˜…èƒ½åŠ›å®ç°å“¨å…µé—´é€šä¿¡å’Œslaveå‘ç°,å“¨å…µä¸masterå»ºç«‹é€šä¿¡ä¹‹å,å¯åˆ©ç”¨masterå®ä¾‹çš„å‘å¸ƒ/è®¢é˜…æœºåˆ¶å‘å¸ƒè‡ªèº«çš„(å“¨å…µ)ipä¸ç«¯å£\nmasteræœ‰ä¸€ä¸ªsentinel:helloçš„ä¸“ç”¨é€šé“,ç”¨æ¥ç»™å“¨å…µä¹‹é—´å‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯,å“¨å…µå¯ä»¥é€šè¿‡è¯¥é€šé“å‘å¸ƒè‡ªå·±çš„nameã€ipã€portæ¶ˆæ¯,åŒæ—¶è®¢é˜…å…¶ä»–å“¨å…µå‘å¸ƒçš„nameã€ipã€portæ¶ˆæ¯,è¿™ä¸å¾®æœåŠ¡ä¸­çš„æœåŠ¡æ³¨å†Œäºå‘ç°ç±»ä¼¼\nå“¨å…µå¦‚ä½•ä¸slaveè¿æ¥ sentinelå‘masterå‘é€infoå‘½ä»¤ masterä¼šè¿”å›æ‰€æœ‰slaveofäº†è‡ªå·±çš„ä»èŠ‚ç‚¹ä¿¡æ¯ sentinelæ ¹æ®masterè¿”å›çš„slaveåˆ—è¡¨,é€ä¸ªä¸slaveå»ºç«‹è¿æ¥,å¹¶æ ¹æ®è¿™ä¸ªè¿æ¥æŒç»­ç›‘æ§ æ€»ç»“ å“¨å…µé›†ç¾¤ä»»åŠ¡ å“¨å…µæœºåˆ¶æ˜¯å®ç°Redisä¸é—´æ–­æœåŠ¡é«˜å¯ç”¨çš„æ‰‹æ®µä¹‹ä¸€,æ˜¯åœ¨masterå®•æœºå,è‡ªåŠ¨ä¸»ä»åˆ‡æ¢æä¾›é«˜å¯ç”¨æœåŠ¡çš„å…³é”®æ”¯æ’‘\nç›‘æ§masterä¸slaveçš„è¿è¡ŒçŠ¶æ€,åˆ¤æ–­æ˜¯å¦å®¢è§‚ä¸‹çº¿ masterå®¢è§‚ä¸‹çº¿å,é€‰æ‹©ä¸€ä¸ªslaveå°†å…¶æ¨ä¸¾ä¸ºæ–°çš„master é€šçŸ¥å…¶ä»–slaveå’Œå®¢æˆ·ç«¯æ–°çš„masterä¿¡æ¯ å“¨å…µé›†ç¾¤åŸç† åŸºäºRedisçš„pub/subæœºåˆ¶å®ç°å“¨å…µé—´çš„é€šä¿¡ åŸºäºINFOå‘½ä»¤è·å–slaveåˆ—è¡¨,å¸®åŠ©å“¨å…µä¸slaveå»ºç«‹è¿æ¥ é€šè¿‡å“¨å…µçš„pub/sub,å®ç°å®¢æˆ·ç«¯å’Œå“¨å…µä¹‹é—´çš„æ—¶é—´é€šçŸ¥ ä¸»ä»åˆ‡æ¢,å¹¶ä¸æ˜¯éšæ„é€‰æ‹©ä¸€ä¸ªå“¨å…µæ¥æ‰§è¡Œè¿™ä¸€ç³»åˆ—çš„åŠ¨ä½œ,è€Œæ˜¯é€šè¿‡ä»²è£æŠ•ç¥¨,é€‰å‡ºä¸€ä¸ªsentinel leader,ç”±è¿™ä¸ªleaderæ¥è´Ÿè´£ä¸»ä»åˆ‡æ¢\n","permalink":"https://www.atomicbot.cloud/posts/tech/redis%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B9%8B%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F/","summary":"èƒŒæ™¯ Redisä¸»ä»æ¨¡å¼ç”±äºæ˜¯è¯»å†™åˆ†ç¦»çš„æ¨¡å¼,å¯ä»¥å¤§å¹…æé«˜æ€§èƒ½å’ŒæœåŠ¡çš„å¯ç”¨æ€§,å‡å°‘ç”šè‡³é¿å…RedisæœåŠ¡å‘ç”Ÿå®•æœºçš„å¯èƒ½,ä¸»ä»æ¨¡å¼çš„ä¸»è¦èƒ½åŠ›å¦‚ä¸‹: æ•…éšœéš”ç¦»å’Œæ¢å¤: æ— è®ºä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹å´©æºƒ,å…¶ä»–èŠ‚ç‚¹ä»ç„¶å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡(ä¸»èŠ‚ç‚¹å´©æºƒæ—¶,æ— æ³•æä¾›å†™æœåŠ¡,éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ä¸»ä») è¯»å†™åˆ†ç¦»:ä¸»èŠ‚ç‚¹è´Ÿ","title":"Redisé«˜å¯ç”¨ä¹‹å“¨å…µæ¨¡å¼"},{"content":"ä¸»ä»å¤åˆ¶ä»‹ç» Redisçš„RDBå’ŒAOFæŒä¹…åŒ–æœºåˆ¶,åªæ˜¯è§£å†³äº†RedisæœåŠ¡å´©æºƒåçš„å¿«é€Ÿæ¢å¤æ•°æ®,ä½†æ˜¯å¹¶æ²¡æœ‰å‡å°‘æˆ–è€…é™ä½RedisæœåŠ¡å´©æºƒçš„å¯èƒ½æ€§,ä¹Ÿå°±æ˜¯æ²¡æœ‰æé«˜RedisæœåŠ¡çš„é«˜å¯ç”¨æ€§.\nç›®å‰Rediså®ç°é«˜å¯ç”¨æœåŠ¡ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼: ä¸»ä»æ¨¡å¼ã€å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼.é¦–å…ˆæ¥è¯´ä¸»ä»æ¨¡å¼.\nRedisçš„ä¸»ä»æ¨¡å¼ä¸»è¦æ˜¯é€šè¿‡å¤åˆ¶çš„æ–¹æ³•,å°†ä¸»èŠ‚ç‚¹ä¸Šçš„Rediså†…å­˜æ•°æ®åŒæ­¥å¤åˆ¶ä¸€ä»½åˆ°ä»èŠ‚ç‚¹ä¸Š,å’ŒMysqlçš„ä¸»ä»æ¨¡å¼å¾ˆç›¸ä¼¼,ä¸»èŠ‚ç‚¹é€šå¸¸ç§°ä¹‹ä¸ºmasterèŠ‚ç‚¹,ä»èŠ‚ç‚¹ç§°ä¹‹ä¸ºslaveèŠ‚ç‚¹,ä¸»ä»å¤åˆ¶çš„æ–¹å‘ä¸ºå•å‘,æ•°æ®åªèƒ½ä»ä¸»èŠ‚ç‚¹å¤åˆ¶åˆ°ä»èŠ‚ç‚¹,ä¸èƒ½åè¿‡æ¥\nä¸»ä»ä¿è¯æ•°æ®ä¸€è‡´æ€§ ä¸ºäº†ä¿è¯ä¸»èŠ‚ç‚¹RedisæœåŠ¡å’Œä»èŠ‚ç‚¹çš„RedisæœåŠ¡çš„æ•°æ®ä¸€è‡´æ€§,åŒæ—¶ä¹Ÿä¸ºäº†åˆ†æ‹…è®¿é—®å‹åŠ›,è´Ÿè½½å‡è¡¡,é€šå¸¸ä¼šåœ¨åº”ç”¨ç¨‹åºä¸­é‡‡å–è¯»å†™åˆ†ç¦»çš„æ¨¡å¼å¯¹äºè¯»æ“ä½œ,å¯ä»¥åŒæ—¶åœ¨ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹æ‰§è¡Œ,å› ä¸ºè¯»å–æ“ä½œæ˜¯å¹‚ç­‰çš„,é€šå¸¸è¯»å–ä¼šåœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œ,å¯¹äºå®æ—¶æ€§å’Œå‡†ç¡®æ€§ç”±100%è¦æ±‚çš„ä¸šåŠ¡,å¯ä»¥è°¨æ…è¯„ä¼°åä»ä¸»èŠ‚ç‚¹è¯»å–,å¯¹äºå†™æ“ä½œ,åªèƒ½åœ¨ä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œ,ä¸»èŠ‚ç‚¹æ‰§è¡Œåå°†å†™æ“ä½œçš„æŒ‡ä»¤åŒæ­¥åˆ°ä»èŠ‚ç‚¹\nä¸ºä»€ä¹ˆé‡‡ç”¨è¯»å†™åˆ†ç¦» ä¸»ä»æ¨¡å¼çš„è¯»å†™åˆ†ç¦»å’ŒMysqlåšè¯»å†™åˆ†ç¦»çš„åŠ¨æœºæ˜¯ä¸€æ ·çš„.å› ä¸ºå·²ç»åˆ’åˆ†äº†ä¸»åº“å’Œä»åº“,ä»åº“çš„æ•°æ®æ˜¯ä»ä¸»åº“å•å‘å¤åˆ¶æ¥çš„,å¦‚æœä¸»åº“å’Œä»åº“éƒ½èƒ½æ‰§è¡Œå†™æ“ä½œ,é‚£ä¹ˆå†™å…¥åˆ°ä»åº“çš„æ•°æ®å°±ä¼šåœ¨ä¸»åº“ä¸­æ— æ³•æŸ¥åˆ°,å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜,è¿™æ˜¯åˆ†å¸ƒå¼æ¨¡å¼çš„é€šç—….å¦‚æœéè¦å¼ºè¡Œä¿è¯æ•°æ®ä¸€è‡´æ€§,ä¸é‚£ä¹ˆRediså°±éœ€è¦åŠ é”,æˆ–è€…ä½¿ç”¨é˜Ÿåˆ—æ‰§è¡Œ,å¹¶ä¸”ç”±äºRedisæ˜¯å•çº¿ç¨‹çš„,åŠ¿å¿…ä¼šä¸¥é‡é™ä½æ€§èƒ½\nä¸»ä»æ¨¡å¼è¿˜æœ‰å…¶ä»–ä»€ä¹ˆä½œç”¨\næ•…éšœéš”ç¦»å’Œæ¢å¤: æ— è®ºæ˜¯masterå´©æºƒæˆ–è€…æ˜¯slaveå´©æºƒ,å…¶ä»–èŠ‚ç‚¹ä¾ç„¶å¯ä»¥æä¾›è¯»å–æœåŠ¡(masterå´©æºƒæ—¶æ— æ³•å†™å…¥),å°½é‡ä¿è¯ç¨‹åºæ­£å¸¸è¿è¡Œ,å¹¶ä¸”å¯ä»¥æ‰‹åŠ¨å°†æŸä¸ªslaveé‡æ–°æŒ‡å®šä¸ºmasterç»§ç»­æä¾›å†™æœåŠ¡ è¯»å†™éš”ç¦»:masterè´Ÿè´£å†™å…¥,slaveè´Ÿè´£è¯»å–,åˆ†æ‘Šæµé‡è´Ÿè½½å‡è¡¡ é«˜å¯ç”¨:ä¸»ä»æ¨¡å¼æ˜¯é«˜å¯ç”¨çš„åŸºçŸ³,å“¨å…µå’Œé›†ç¾¤éƒ½æ˜¯åŸºäºä¸»ä»æ¨¡å¼è€Œæ¥çš„ ä¸»ä»æ¨¡å¼å®è·µ ä¸»ä»å¤åˆ¶çš„å¼€å¯,å®Œå…¨æ˜¯åœ¨ä»èŠ‚ç‚¹å‘èµ·çš„åŠ¨ä½œ,ä¸éœ€è¦åœ¨ä¸»èŠ‚ç‚¹ä¸Šåšä»»ä½•äº‹,é€šè¿‡ä½¿ç”¨replicaof(5.0ç‰ˆæœ¬å‰ä½¿ç”¨slaveof)å‘½ä»¤å¯ä»¥å½¢æˆä¸»ä»å…³ç³»\nå¼€å¯ä¸»ä»å¤åˆ¶æœ‰ä¸‰ç§æ–¹å¼:\né…ç½®æ–‡ä»¶æ–¹å¼ åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šmasterèŠ‚ç‚¹çš„ipå’Œç«¯å£ replicaof \u0026lt;masterip\u0026gt; \u0026lt;masterport\u0026gt;\nå¯åŠ¨å‘½ä»¤æ–¹å¼ åœ¨å¯åŠ¨Rediså®ä¾‹æ—¶åŠ å…¥å‚æ•° ./redis-server redis.conf --replicaof 127.0.0.1 18080\nå®¢æˆ·ç«¯ä½¿ç”¨å‘½ä»¤æ–¹å¼ ä½¿ç”¨redis-cliç™»å½•å®ä¾‹å,æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤,å»ºç«‹ä¸»ä»å…³ç³»\nSLAVEOF 127.0.0.1 18080\næŸ¥çœ‹èŠ‚ç‚¹é—´çš„ä¸»ä»æƒ…å†µ æ•°æ®åŒæ­¥äºè¯»å†™åˆ†ç¦» ä»å®éªŒæ¥çœ‹,ä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®å,ä»èŠ‚ç‚¹å¯ä»¥ç«‹åˆ»è¯»å–åˆ°è¯¥æ•°æ®,å¹¶ä¸”ä»èŠ‚ç‚¹æ˜¯ç¦æ­¢æ‰§è¡Œå†™æ“ä½œçš„,æ•°æ®çš„å†™å…¥åªèƒ½åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œ,å®ç°äº†è¯»å†™åˆ†ç¦»\nä¸»ä»å¤åˆ¶åŸç† ä¸»ä»æ¨¡å¼å¼€å¯å,åº”ç”¨å±‚é‡‡ç”¨è¯»å†™åˆ†ç¦»,æ‰€æœ‰æ•°æ®çš„å†™æ“ä½œåªä¼šåœ¨ä¸»åº“ä¸Šæ‰§è¡Œ,æ‰€æœ‰è¯»æ“ä½œåœ¨ä»åº“ä¸Šæ‰§è¡Œ(ç‰¹æ®Šæƒ…å†µå¯ä»¥ä»ä¸»åº“è¯»å–)\nä¸»ä»ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§,ä¸»åº“æ•°æ®æ›´æ–°åä¼šç«‹å³åŒæ­¥åˆ°ä»åº“\nä¸»ä»åº“çš„åŒæ­¥æ­¥éª¤ ä¸»ä»åº“çš„æ•°æ®åŒæ­¥ä¸»è¦æœ‰ä¸‰ç§æƒ…å†µ\né¦–æ¬¡é…ç½®ä¸»ä»åº“æ—¶çš„å…¨é‡æ•°æ®åŒæ­¥ ä¸»ä»åº“æ­£å¸¸è¿è¡ŒæœŸé—´çš„æ•°æ®å®æ—¶åŒæ­¥ ä¸»ä»å®ä¾‹ç½‘ç»œæ–­å¼€ä¸€æ®µæ—¶é—´åé‡è¿æ—¶å¯¹å¢é‡æ•°æ®çš„åŒæ­¥å’Œå®æ—¶æ•°æ®çš„åŒæ­¥ ç¬¬ä¸€æ¬¡å…¨é‡åŒæ­¥ ç¬¬ä¸€æ¬¡å…¨é‡åŒæ­¥ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ: å‡†å¤‡é˜¶æ®µ ä¸»åº“åŒæ­¥æ•°æ®åˆ°ä»åº“ å‘é€åŒæ­¥æœŸé—´çš„å¢é‡æŒ‡ä»¤åˆ°ä»åº“\nå»ºç«‹è¿æ¥:\nä»èŠ‚ç‚¹åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†replicaof \u0026lt;masterip\u0026gt; \u0026lt;masterport\u0026gt;å‚æ•°,ä»èŠ‚ç‚¹å°±çŸ¥é“éœ€è¦å»å“ªä¸ªä¸»èŠ‚ç‚¹åŒæ­¥æ•°æ® è¿æ¥æˆåŠŸå,ä»åº“å¼€å¯replicaofæ“ä½œ,åŒæ—¶å‘é€psyncæŒ‡ä»¤å‘Šè¯‰ä¸»åº“,æˆ‘å‡†å¤‡å¼€å§‹åŒæ­¥æ•°æ®äº†,psyncæŒ‡ä»¤åŒ…å«runIdå’Œoffset2ä¸ªå‚æ•° runId: æ¯ä¸ªrediså®ä¾‹å¯åŠ¨æˆåŠŸåä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå”¯ä¸€æ ‡è¯†,ä»åº“ç¬¬ä¸€æ¬¡åŒæ­¥è¿˜ä¸çŸ¥é“ä¸»åº“çš„runID,æ‰€ä»¥å‚æ•°é»˜è®¤æ—¶? ç¬¬ä¸€æ¬¡å¤åˆ¶æ—¶,æ²¡æœ‰åç§»é‡,offsetè®¾ç½®ä¸º-1,è¿™æ ·å°±ä¼šä»ä¸»åº“çš„ç¬¬ä¸€æ¡æŒ‡ä»¤å¼€å§‹å¤åˆ¶ ä¸»åº“æ”¶åˆ°psyncæŒ‡ä»¤åæ ¹æ®å‚æ•°å¯åŠ¨å¤åˆ¶,ä½¿ç”¨FULLRESYNCæ¥å“åº”å‘½ä»¤,åŒæ—¶å¸¦ä¸Š2ä¸ªå‚æ•°:ä¸»åº“çš„runIDå’Œä¸»åº“ç›®å‰çš„å¤åˆ¶è¿›åº¦,è¿”å›ç»™ä»åº“ ä»åº“æ”¶åˆ°å“åº”å,è®°å½•ä¸‹è¿™2ä¸ªå‚æ•° ä¸»åº“åŒæ­¥æ•°æ®ç»™ä»åº“\nmasterèŠ‚ç‚¹æ‰§è¡ŒBGSAVEæŒ‡ä»¤ç”ŸæˆRDBæ–‡ä»¶,å°†æ–‡ä»¶å‘é€ç»™ä»åº“,ä»åº“æ”¶åˆ°RDBæ–‡ä»¶å,ä¿å­˜åˆ°ç£ç›˜,æ¸…ç©ºå½“å‰Rediså®ä¾‹ä¸­çš„æ•°æ®,å†å°†RDNæ–‡ä»¶ä¸­çš„æ•°æ®åŠ è½½åˆ°å†…å­˜\nä¸»åº“ä¼šä¸ºæ¯ä¸€ä¸ªä»åº“å¼€è¾Ÿä¸€å—replication bufferçš„ç¼“å†²åŒºè®°å½•,ç”¨äºè®°å½•åœ¨RDBæ–‡ä»¶ç”Ÿæˆåä¸»åº“æ¥æ”¶åˆ°çš„æ‰€æœ‰å†™æŒ‡ä»¤\nå‘é€æ–°çš„å†™å‘½ä»¤åˆ°ä»åº“\nä»åº“åœ¨åˆå§‹åŒ–å®ŒRDBæ–‡ä»¶ä¸­çš„æ•°æ®åˆ°å†…å­˜ä¹‹å,ç»§ç»­æ‰§è¡Œä»replication bufferå‘é€è¿‡æ¥çš„æ•°æ®,é¿å…å‡ºç°æ•°æ®æ–­å±‚\nreplication bufferç¼“å†²åŒºåˆ›å»ºåœ¨masterä¸»åº“ä¸Š,å­˜æ”¾çš„æ˜¯ä»¥ä¸‹æ—¶é—´å†…masteræ•°æ®çš„å†™æ“ä½œ\nmasteræ‰§è¡ŒBGSAVEæŒ‡ä»¤æœŸé—´çš„å†™æ“ä½œ masterä¼ è¾“RDBæ–‡ä»¶åˆ°ä»åº“æœŸé—´çš„å†™æ“ä½œ slaveåˆå§‹åŒ–RDBæ–‡ä»¶åˆ°å†…å­˜æœŸé—´çš„å†™æ“ä½œ ä¸‰ä¸ªæ­¥éª¤å®Œæˆäº†Redisä»åº“çš„ç¬¬ä¸€æ¬¡å…¨é‡å¤åˆ¶,RDBä½œä¸ºäºŒè¿›åˆ¶æ–‡ä»¶,æ— è®ºæ˜¯ç½‘ç»œä¼ è¾“è¿˜æ˜¯å†™ç›˜çš„IO,æ•ˆç‡éƒ½æ¯”AOFæ›´å¿«,æ‰€ä»¥ä¸»ä»æ¨¡å¼ä¼šé€‰æ‹©RDBæ–‡ä»¶æ¥åšåŒæ­¥\nå¢é‡åŒæ­¥ åœ¨ç½‘ç»œæ–­å¼€ä¹‹åæˆ–è€…ä»åº“æ•…éšœæ¢å¤ä¹‹å,ä¸»ä»æ¨¡å¼ä¼šé‡‡ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼ç»§ç»­åŒæ­¥,è€Œä¸æ˜¯å…¨é‡åŒæ­¥,æ¥æå‡æ•ˆç‡\nä»åº“åœ¨æ•…éšœæ¢å¤ä¹‹åå¯ä»¥å®ç°å¢é‡å¤åˆ¶çš„å…³é”®å°±åœ¨repl_backlog_bufferç¼“å†²åŒºä¸Šé¢,masterä¼šå°†å†™æŒ‡ä»¤è®°å½•åˆ°repl_backlog_bufferä¸­,å¹¶ä½¿ç”¨master_repl_offsetè®°å½•masterå†™å…¥çš„ä½ç½®åç§»é‡,slaveåˆ™ä½¿ç”¨slave_repl_offsetæ¥è¯»å–åç§»é‡,æ‰€ä»¥masteråœ¨æ–°å¢å†™æ“ä½œçš„æ—¶å€™,åç§»é‡ä¼šå¢åŠ ,é€šå¸¸æƒ…å†µä¸‹,è¿™2ä¸ªåç§»é‡ä¼šä¿æŒåŒæ­¥\nä½†æ˜¯å½“ç½‘ç»œæ–­å¼€æˆ–è€…ä»åº“æ•…éšœæ¢å¤å,ä¸»åº“ç»§ç»­æ”¶åˆ°å†™æ“ä½œ,ä»åº“æš‚åœæ‰§è¡Œ,å°±ä¼šå¯¼è‡´master_repl_offsetå¤§äºslave_repl_offset\nåœ¨ä»åº“é‡æ–°è¿æ¥ä¹‹å,ä»åº“å‘ä¸»åº“å‘é€psyncæŒ‡ä»¤,å¹¶å°†è‡ªå·±çš„runIDå’Œslave_repl_offset2ä¸ªå‚æ•°å‘ç»™ä¸»åº“,ä¸»åº“åªéœ€è¦å°†master_repl_offsetä¸slave_repl_offsetä¹‹é—´çš„å†™æ“ä½œæŒ‡ä»¤å‘é€ç»™ä»åº“å³å¯\nåœ¨é…ç½®repl_backlog_buffer_sizeçš„æ—¶å€™,éœ€è¦è€ƒè™‘å¤šæ–¹å› ç´ ,å¤ªå¤§äº†ä¼šå¯¼è‡´å¢é‡åŒæ­¥çš„æ‰§è¡Œæ—¶é—´è¾ƒé•¿,è¿˜ä¸å¦‚RDBå…¨è¦†ç›–,å¤ªå°äº†çš„è¯,ä»åº“æœ‰å¯èƒ½è¿˜æ²¡æœ‰è¯»å–åˆ°ç¼“å†²åŒºçš„æ•°æ®å°±è¢«masterçš„æ–°çš„å†™æ“ä½œç»™è¦†ç›–äº†\nä¸€èˆ¬æƒ…å†µä¸‹çš„ç¼“å†²åŒºè®¡ç®—å…¬å¼: repl_backlog_buffer_size = seconds * write_size_per_second * 1.5\nseconds:æ­£å¸¸æƒ…å†µä¸‹,ä¸»åº“æ–­å¼€åˆ°é‡è¿çš„å¹³å‡æ—¶é—´,å•ä½ç§’\nwrite_size_per_second: ä¸»åº“å¹³å‡æ¯ç§’äº§ç”Ÿçš„å†™æŒ‡ä»¤æ•°é‡\n1.5: é¢„ç•™å®¹é‡\nåŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ ä»¥ä¸Šçš„åŒæ­¥éƒ½æ˜¯ä¸ºäº†å®Œæˆå®Œæˆçš„å¤åˆ¶,åœ¨å®Œæ•´å¤åˆ¶å®Œ,ä¸»ä»æ­£å¸¸å·¥ä½œå¼€å§‹åè¿›è¡ŒåŒæ­¥éœ€è¦ä¿æŒé•¿è¿æ¥,åœ¨ä¸»åº“æ¥æ”¶åˆ°å†™æ“ä½œæŒ‡ä»¤å,é€šè¿‡è¿™ä¸ªé•¿è¿æ¥åŒæ­¥ç»™ä»åº“,è¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºåŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­,ä¸ºäº†å®æˆä¼ æ’­çš„æœ‰æ•ˆæ€§å’Œç¨³å®šæ€§,ä»èŠ‚ç‚¹é‡‡ç”¨å¿ƒè·³æœºåˆ¶è¿›è¡Œä¾¦æµ‹,å‘é€å‘½ä»¤ PINGå’ŒREPLCONF ACK\næ¯éš”ä¸€å®šæ—¶é—´(é…ç½®ä¸­é…ç½®),æ¯”å¦‚30S,ä¸»èŠ‚ç‚¹ä¼šå‘ä»èŠ‚ç‚¹å‘é€PINGå‘½ä»¤æ¥åˆ¤æ–­ä»èŠ‚ç‚¹çš„å¥åº·æƒ…å†µ.\nå‘½ä»¤ä¼ æ’­é˜¶æ®µ,ä»èŠ‚ç‚¹ä¼šé»˜è®¤ä»¥æ¯ç§’çš„é¢‘ç‡å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤,å°†ä»èŠ‚ç‚¹å·²ç»å¤åˆ¶çš„åç§»é‡å‘é€è¿‡å» REPLCONF ACK \u0026lt;replication_offset\u0026gt;, replication_offsetå±æ€§æ˜¯æŒ‡å½“å‰ä»èŠ‚ç‚¹å·²ç»ä»ä¸»èŠ‚ç‚¹å¤åˆ¶çš„åç§»é‡,ä»èŠ‚ç‚¹å‘é€è¿™ä¸ªREPLCONF ACKå‘½ä»¤çš„ä¸»è¦ä½œç”¨æœ‰3ä¸ª:\næ£€æŸ¥ä¸»èŠ‚ç‚¹çš„å¥åº·çŠ¶å†µå’Œç½‘ç»œæƒ…å†µ è¾…åŠ©å®ç°min-slavesé€‰é¡¹,Redisçš„min-slaves-to-write(å°‘äºNä¸ªä»èŠ‚ç‚¹æ—¶æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤)å’Œmin-slaves-lag(ä¸»ä»å»¶è¿Ÿå¤§äºç­‰äºNç§’æ—¶,æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤),è¿™2ä¸ªé€‰é¡¹å¯ä»¥é˜²æ­¢ä¸»æœåŠ¡å™¨åœ¨ä¸å®‰å…¨çš„æƒ…å†µä¸‹æ‰§è¡Œå†™å‘½ä»¤ æ£€æµ‹æ•°æ®ä¸¢å¤±: ä»èŠ‚ç‚¹å‘é€äº†slave_repl_offsetåç§»é‡,ä¸»èŠ‚ç‚¹ä¼šå’Œmaster_repl_offsetè¿›è¡Œå¯¹æ¯”,å¦‚æœä¸ä¸€è‡´,è¯´æ˜ä»èŠ‚ç‚¹ä¸¢å¤±äº†æ•°æ®,ä¸»èŠ‚ç‚¹ä¼šä»repl_backlog_bufferä¸­å°†2ä¸ªoffsetåŒºé—´çš„æŒ‡ä»¤æ‰¾åˆ°å¹¶æ¨é€ç»™ä»èŠ‚ç‚¹ å¦‚ä½•ç¡®å®šå…¨é‡è¿˜æ˜¯å¢é‡ æ ¸å¿ƒç‚¹å°±æ˜¯ä»èŠ‚ç‚¹å‘é€çš„psyncæŒ‡ä»¤:\nä»èŠ‚ç‚¹æ ¹æ®è‡ªèº«æ˜¯å¦éœ€è¦å…¨é‡å‘é€psyncç»™ä¸»èŠ‚ç‚¹ å¦‚æœä»æœªæ‰§è¡Œè¿‡replicaof,åˆ™å‘é€psync ? -1,ä»£è¡¨å…¨é‡å¤åˆ¶ å¦‚æœä¹‹å‰åŒæ­¥è¿‡,åˆ™å–å½“å‰å®ä¾‹çš„runIDå’Œå·²åŒæ­¥çš„offsetå‘é€æŒ‡ä»¤ psync \u0026lt;runID\u0026gt; \u0026lt;slave_repl_offset\u0026gt; ä¸»èŠ‚ç‚¹æ ¹æ®psyncè´¨é‡çš„å‚æ•°å†³å®šæ˜¯å…¨é‡åŒæ­¥è¿˜æ˜¯å¢é‡åŒæ­¥ ä¸»,ä»èŠ‚ç‚¹çš„runIDä¸€è‡´,å¹¶ä¸”ä»èŠ‚ç‚¹å‘é€çš„slave_repl_offsetåœ¨repl_backlog_bufferä¸­å­˜åœ¨(ç¯å½¢é—­åˆçš„å†…å­˜ç¼“å†²åŒº,æœ‰å¯èƒ½è¢«æ“¦é™¤äº†),åˆ™å›å¤CONTINUE,ä»£è¡¨ä»¥å¢é‡æ¨¡å¼è¿›è¡Œå¤åˆ¶ ä¸»,ä»èŠ‚ç‚¹çš„runIDä¸ä¸€è‡´,æˆ–è€…ä»èŠ‚ç‚¹å‘é€çš„slave_repl_offsetåœ¨repl_backlog_bufferä¸­ä¸å­˜åœ¨(å¯èƒ½æ˜¯ä»èŠ‚ç‚¹å®•æœºæ—¶é—´è¿‡ä¹…),åˆ™å›å¤FULLRESYNC \u0026lt;runId\u0026gt; \u0026lt;offset\u0026gt;è¡¨ç¤ºè¦è¿›è¡Œå…¨é‡å¤åˆ¶,åŒæ—¶è®°å½•ä¸‹ä¸»èŠ‚ç‚¹çš„runIDå’Œoffset ä¸€ä¸»å¤šä»åŒæ­¥çš„ç†è§£ ä»ä»¥ä¸Šå†…å®¹å¯ä»¥å¾—çŸ¥:\nå¤šä¸ªä»åº“çš„æƒ…å†µä¸‹,æ¯ä¸ªä»åº“éƒ½ä¼šè®°å½•è‡ªå·±çš„slave_repl_offset,å„è‡ªçš„å¤åˆ¶è¿›åº¦ä¹Ÿä¸ç›¸åŒ ä»åº“é‡è¿è¿›è¡Œæ¢å¤æ—¶,ä¼šé€šè¿‡psyncå‘½ä»¤å°†è‡ªå·±çš„slave_repl_offsetå‘Šè¯‰ä¸»åº“,ä¸»åº“æ¥åˆ¤æ–­æ˜¯å¢é‡å¤åˆ¶è¿˜æ˜¯å…¨é‡å¤åˆ¶ replication bufferå’Œrepl_backlog_bufferçš„è¯´æ˜:\nreplication bufferæ˜¯ä¸»ä»åº“åœ¨è¿›è¡Œå…¨é‡å¤åˆ¶æ—¶,ä¸»åº“ä¸Šç”¨äºå’Œä»åº“è¿æ¥çš„å®¢æˆ·ç«¯buffer,repl_backlog_bufferæ˜¯ä¸ºäº†æ”¯æŒä»åº“çš„å¢é‡å¤åˆ¶,ä¸»åº“ä¸Šç”¨äºæŒç»­è®°å½•ä¸»åº“å†™æ“ä½œçš„ä¸€å—ä¸“ç”¨buffer,æ‰€æœ‰ä»åº“å…±äº«.\n","permalink":"https://www.atomicbot.cloud/posts/tech/redis%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B9%8B%E4%B8%BB%E4%BB%8E%E6%A8%A1%E5%BC%8F/","summary":"ä¸»ä»å¤åˆ¶ä»‹ç» Redisçš„RDBå’ŒAOFæŒä¹…åŒ–æœºåˆ¶,åªæ˜¯è§£å†³äº†RedisæœåŠ¡å´©æºƒåçš„å¿«é€Ÿæ¢å¤æ•°æ®,ä½†æ˜¯å¹¶æ²¡æœ‰å‡å°‘æˆ–è€…é™ä½RedisæœåŠ¡å´©æºƒçš„å¯èƒ½æ€§,ä¹Ÿå°±æ˜¯æ²¡æœ‰æé«˜RedisæœåŠ¡çš„é«˜å¯ç”¨æ€§. ç›®å‰Rediså®ç°é«˜å¯ç”¨æœåŠ¡ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼: ä¸»ä»æ¨¡å¼ã€å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼.é¦–å…ˆæ¥è¯´ä¸»ä»æ¨¡å¼. R","title":"Redisé«˜å¯ç”¨ä¹‹ä¸»ä»æ¨¡å¼"},{"content":"ä»‹ç» ","permalink":"https://www.atomicbot.cloud/posts/tech/%E5%88%86%E5%B8%83%E5%BC%8F%E7%AE%97%E6%B3%95%E4%B9%8B-%E4%B8%80%E8%87%B4%E6%80%A7hash%E7%AE%97%E6%B3%95/","summary":"ä»‹ç»","title":"åˆ†å¸ƒå¼ç®—æ³•ä¹‹--ä¸€è‡´æ€§hashç®—æ³•.md"},{"content":"ä»‹ç» Redisé€šå¸¸ç”¨æ¥ä½œä¸ºåº”ç”¨ç¨‹åºä¸æ•°æ®åº“DBä¹‹é—´çš„ä¸€å±‚ç¼“å­˜ä¸­é—´ä»¶,æ¥ä¿è¯æ•°æ®çš„è®¿é—®æ•ˆç‡,é‚£æ—¢ç„¶æ˜¯ä¸€å±‚ä¸­é—´ä»¶,å¿…ç„¶å­˜åœ¨å®•æœºã€å´©æºƒçš„é—®é¢˜,ä¸€æ—¦RedisæœåŠ¡ä¸å¯ç”¨,å¯èƒ½äº§ç”Ÿçš„åæœåŒ…æ‹¬:\nRedisè¿›ç¨‹ä¸­ä¿å­˜çš„æ•°æ®å…¨éƒ¨ä¸¢å¤±,å¼•æ–‡Redisæ•°æ®æ˜¯å­˜åœ¨RAMä¸­çš„ æ•°æ®è®¿é—®ä»å†…å­˜çº§åˆ«é™ä½è‡³IOçº§åˆ«,æ€§èƒ½ä¸‹é™æ˜æ˜¾ åŸæœ¬å¤§é‡è®¿é—®ç¼“å­˜çš„è¯·æ±‚ç°åœ¨éƒ½è¯·æ±‚åˆ°æ•°æ®åº“,å¯èƒ½å¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§,ç”šè‡³é›ªå´© æ‰€ä»¥Redisä¸­é—´ä»¶å´©æºƒåçš„ç»“æœæ˜¯å¾ˆä¸¥é‡çš„,ä¸ºäº†é¿å…å®•æœºåRAMä¸­çš„æ•°æ®ä¸¢å¤±,Redisæä¾›2ä¸­æ•°æ®æŒä¹…åŒ–çš„èƒ½åŠ›,RDB (Redis Database)å’ŒAOF (Append Only File)\nå…³äºRDB Rediså’ŒMysqlçš„æœ€å¤§åŒºåˆ«å°±æ˜¯ä¸€ä¸ªå°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜,ä¸€ä¸ªå­˜å‚¨åœ¨ç£ç›˜,å¦‚æœæ¯æ¬¡æ•°æ®çš„å˜åŒ–CUDéƒ½è¦åŒæ—¶å†™å†…å­˜å’Œç¡¬ç›˜,é‚£æ€§èƒ½æˆæœ¬å°±å¤ªé«˜äº†,è€Œä¸”è¿˜éœ€è¦ä¿è¯åŸå­æ€§,é¿å…å†…å­˜å’Œç£ç›˜æ•°æ®çš„ä¸€è‡´æ€§\nRDB ä¸ºäº†é¿å…ä¿®æ”¹æ•°æ®æ—¶å®æ—¶å†™å…¥å†…å­˜,Redisæä¾›äº†RDB,å†…å­˜å¿«ç…§åŠŸèƒ½,å†…å­˜å¿«ç…§æ˜¯æŒ‡åœ¨æŸä¸€æ—¶åˆ»,Rediså†…å­˜ä¸­æ•°æ®çš„çŠ¶æ€,å¿«ç…§æ–‡ä»¶å°±ç§°ä¹‹ä¸ºRDBæ–‡ä»¶,Rediså¯ä»¥é€šè¿‡å®šæœŸæ‰§è¡ŒRDBå†…å­˜å¿«ç…§,å°†Rediså†…å­˜ä¸­çš„æ•°æ®å¤‡ä»½åˆ°ç£ç›˜,ä¾¿å¯ä»¥é¿å…é«˜é¢‘çš„æ›´æ–°å†…å­˜,æ—¢ä¿è¯äº†Redisçš„é«˜æ•ˆè¯»å†™,è¿˜å®ç°äº†å®•æœºåå¿«é€Ÿæ¢å¤æ•°æ®\nRDBå¿«ç…§ Redisæä¾›2ç§æ–¹å¼ç”ŸæˆRDBå¿«ç…§æ–‡ä»¶:\nSAVE: ç”±ä¸»çº¿ç¨‹æ¥æ‰§è¡Œ,åŒæ­¥é˜»å¡,åªæœ‰å½“saveå‘½ä»¤ä¿å­˜å®Œå¿«ç…§å,ä¸»çº¿ç¨‹æ‰èƒ½å“åº”åº”ç”¨ç¨‹åºçš„è¯·æ±‚ BGSAVE:æ‰§è¡Œå,ä¼šç«‹å³è¿”å›OK,åŒæ—¶è°ƒç”¨glibcçš„å‡½æ•°,forkå‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥æŒä¹…åŒ–å¿«ç…§,å¿«ç…§çš„æŒä¹…åŒ–å®Œå…¨äº¤ç»™å­è¿›ç¨‹,ä¸»è¿›ç¨‹å¯¹äºåº”ç”¨ç¨‹åºçš„è¯»å†™ä¸é˜»å¡,ç›¸å½“äºå†™RDBçš„æ“ä½œæ˜¯ä¸€ä¸ªå¼‚æ­¥åŠ¨ä½œ SAVEæ¨¡å¼ SAVEæ¨¡å¼ä¸‹çš„å¿«ç…§æŒä¹…åŒ–æ“ä½œæ˜¯ä¸»è¿›ç¨‹åœ¨æ‰§è¡Œ,ç”±äºRedisæ˜¯å•çº¿ç¨‹,ä¼šé˜»å¡åº”ç”¨ç¨‹åºçš„è¯·æ±‚,ä¸å»ºè®®ä½¿ç”¨\nBGSAVEæ¨¡å¼ Redisä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹å†™æ—¶å¤åˆ¶COW(copy on write)æ¥å®ç°å¿«ç…§æŒä¹…åŒ–,ç”±äºforkå‡ºæ¥çš„å­è¿›ç¨‹å’ŒRedisä¸»è¿›ç¨‹å…±äº«å†…å­˜,æ‰€ä»¥å­è¿›ç¨‹è¯»å–ä¸»è¿›ç¨‹çš„æ•°æ®æ¥å†™å…¥RDBæ–‡ä»¶,ä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å“åº”åº”ç”¨ç¨‹åºçš„è¯·æ±‚,2è€…äº’ä¸å½±å“,å¹¶ä¸”åœ¨åˆ›å»ºRDBæ–‡ä»¶æ—¶,ç¨‹åºä¼šå¯¹å†…å­˜ä¸­çš„æ•°æ®åšä¸€éæ£€æŸ¥,ä»…ä»…ä¼šå°†æœªè¿‡æœŸçš„é”®å€¼ä¿å­˜åˆ°RDBæ–‡ä»¶ä¸­\nRDBé…ç½® RDBæ¨¡å¼ä½•æ—¶è¿›è¡Œå¿«ç…§RDBæ–‡ä»¶çš„å­˜å‚¨,æ˜¯åœ¨Redisé…ç½®æ–‡ä»¶ä¸­è¿›è¡ŒæŒ‡å®š,ä»¥ä¸‹æˆªå–éƒ¨åˆ†æºç ä¸­çš„é…ç½®è¯´æ˜\né¿å…RDBæ‰§è¡Œé¢‘ç‡è¿‡é«˜ è™½ç„¶è¯´RDBå¿«ç…§å­˜å‚¨,æ˜¯åœ¨å­è¿›ç¨‹ä¸­è¿›è¡Œçš„,ä¸ä¼šå½±å“ä¸»è¿›ç¨‹å¯¹å®¢æˆ·ç«¯çš„è¯·æ±‚å¤„ç†,ä½†æ˜¯å¦‚æœRDBæ‰§è¡Œé¢‘ç‡è¿‡é«˜å°±ä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½å¼€é”€\né¢‘ç¹çš„åˆ›å»ºRDBæ–‡ä»¶å†™å…¥å†…å­˜,å¯¼è‡´ç£ç›˜å‹åŠ›è¿‡å¤§,æ•ˆç‡é™ä½ forkå‡ºæ¥çš„å­è¿›ç¨‹ç”±äºå…±äº«ä¸»çº¿ç¨‹çš„æ•°æ®,ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿä¼šé˜»å¡ä¸»çº¿ç¨‹çš„è¿è¡Œ,ä¸»è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜è¶Šå¤§,å­˜å‚¨çš„æ•°æ®è¶Šå¤š,é˜»å¡æ—¶é—´è¶Šé•¿ RDBæ€»ç»“ å¿«ç…§RDBæ˜¯å¯¹å†…å­˜æ•°æ®è¿›è¡Œçš„å…¨é‡æŒä¹…åŒ–,ä½†æ˜¯ç”ŸæˆRDBéœ€è¦æŠŠæ¡ä¸€ä¸ªåº¦,é¢‘ç‡å¤ªå¿«ä¼šå¯¼è‡´é¢å¤–å¼€é”€è¿‡å¤§,æ€§èƒ½é™ä½,é¢‘ç‡å¤ªä½çš„è¯,RDBæ–‡ä»¶å’Œå†…å­˜ä¸­çš„æ•°æ®å·®å¼‚å°±è¶Šå¤§,ä¸¢å¤±çš„æ•°æ®å°±è¶Šå¤š RDBå»ºè®®é‡‡ç”¨äºŒè¿›åˆ¶+æ•°æ®å‹ç¼©æ–¹å¼å†™å…¥ç£ç›˜,é»˜è®¤ä¹Ÿæ˜¯å¼€å¯RDBå‹ç¼©çš„ AFOæ—¥å¿—æ–‡ä»¶ AOFæ—¥å¿—æ–‡ä»¶å­˜å‚¨çš„æ˜¯Rediså¯¹å†…å­˜çš„ä¿®æ”¹çš„æŒ‡ä»¤è®°å½•,å‡è®¾AOFæ—¥å¿—æ–‡ä»¶è®°å½•äº†è‡ªRediså®ä¾‹åˆ›å»ºä»¥æ¥çš„æ‰€æœ‰ä¿®æ”¹å†…å­˜çš„æŒ‡ä»¤åºåˆ—,é‚£ä¹ˆå¯ä»¥å¯¹ä¸€ä¸ªç©ºçš„Rediså®ä¾‹æŒ‰ç…§é¡ºåºæ‰§è¡Œè¿™äº›æŒ‡ä»¤å°±å¯ä»¥è¿˜åŸæ‰€æœ‰æ•°æ®,ç±»ä¼¼ä¸gitçš„rebase\næ—¥å¿—å˜æ›´å¯¹æ¯” AOFè®°å½•æ—¥å¿—æœ‰2ç§æ–¹å¼:\nå†™å‰æ—¥å¿—:åœ¨æ‰§è¡ŒRediså‘½ä»¤ä¹‹å‰,å…ˆå°†æŒ‡ä»¤è®°å½•åˆ°AOFæ—¥å¿—æ–‡ä»¶,ç„¶åå†æ‰§è¡ŒæŒ‡ä»¤,ç±»ä¼¼äºMySqlç§çš„redo log,ä¿®æ”¹æ•°æ®å‰å…ˆè®°å½•æ—¥å¿— å†™åæ—¥å¿—:å…ˆæ‰§è¡ŒæŒ‡ä»¤,ç„¶åå†å°†æŒ‡ä»¤å†™å…¥AOFæ—¥å¿—æ–‡ä»¶ æ—¥å¿—æ ¼å¼ Redisåœ¨æ¥æ”¶åˆ°set keyName someValueæŒ‡ä»¤çš„æ—¶å€™,ä¼šå…ˆå°†æ•°æ®å†™åˆ°å†…å­˜,ç„¶åæŒ‰ç…§å¦‚ä¸‹çš„æ ¼å¼å†™å…¥ AOFæ–‡ä»¶ä¸­. *3è¡¨ç¤ºè¯¥æ¡æŒ‡ä»¤åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†,æ¯ä¸ªéƒ¨åˆ†éƒ½æ˜¯$ + æ•°å­—å¼€å¤´,åé¢æ˜¯æ¯ä¸ªéƒ¨åˆ†çš„å…·ä½“å†…å®¹: æŒ‡ä»¤ã€é”®ã€å€¼,æ•°å­—è¡¨ç¤ºè¿™éƒ¨åˆ†å‘½ä»¤å ç”¨çš„è‡ªèŠ‚å¤§å°\næ¨èä½¿ç”¨å†™åæ—¥å¿—çš„æ¨¡å¼,å› ä¸ºè¿™æ ·åœ¨è®°å½•æ—¥å¿—æ—¶ä¸ç”¨å¯¹æŒ‡ä»¤åšè¯­æ³•æ£€æŸ¥,å¦‚æœä½¿ç”¨å†™å‰æ—¥å¿—,éœ€è¦å¯¹æŒ‡ä»¤åšè¯­æ³•æ£€æŸ¥\nå¯èƒ½å­˜åœ¨çš„é—®é¢˜ å¯èƒ½å­˜åœ¨æ•°æ®ä¸¢å¤±:Redisæ‰§è¡Œå®ŒæŒ‡ä»¤åè¿˜æ²¡æœ‰å†™å…¥AOFæ—¥å¿—æˆåŠŸå°±å®•æœºäº† AOFé¿å…äº†å½“å‰æ˜äº®çš„é˜»å¡,ä½†æ˜¯AOFæ˜¯ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œ,å°†æ—¥å¿—å†™å…¥ç£ç›˜çš„è¿‡ç¨‹ä¸­,å¦‚æœIOå‹åŠ›è¿‡å¤§,å°±ä¼šå¯¼è‡´æ‰§è¡Œç¼“æ…¢ å†™å›ç­–ç•¥ ä¸Šé¢çš„é—®é¢˜åœ¨Redisé«˜é¢‘è¯»å†™æ—¶æ˜¯å¿…ç„¶å­˜åœ¨çš„,æƒ³è¦è§£å†³,åœ¨å†™å…¥æ—¶åšä¸€å±‚ç¼“å†²å°±å¯ä»¥äº†,é¿å…ç›´å¡,Redisæä¾›äº†ä¸€ç§æ‰§è¡Œç­–ç•¥å«åšå›å†™ç­–ç•¥\nå›å†™ç­–ç•¥è¯´æ˜ ä¸ºäº†æé«˜AOFæ—¥å¿—æ–‡ä»¶çš„å†™å…¥æ•ˆç‡,å›å†™ç­–ç•¥ä¼šåšå…¥ä¸‹è°ƒæ•´:\nåœ¨è°ƒç”¨writeå‡½æ•°é¡¹æ—¥å¿—æ–‡ä»¶å†™å…¥æ•°æ®æ—¶,å¹¶ä¸æ˜¯çœŸæ­£çš„è½ç›˜,è€Œæ˜¯å°†æ•°æ®å†™å…¥åˆ°æ“ä½œç³»ç»Ÿçš„å†…å­˜ç¼“å†²åŒº. å½“ç¼“å†²åŒºçš„ç©ºé—´è¢«å¡«æ»¡æˆ–è€…è¶…è¿‡äº†æŒ‡å®šçš„é˜ˆå€¼,æ‰ä¼šçœŸæ­£å°†ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ°ç£ç›˜ä¸­,è¿™ç§æ–¹å¼è™½ç„¶æé«˜äº†æ•ˆç‡,ä½†æ˜¯å¯èƒ½å­˜åœ¨æ•°æ®å®‰å…¨æ€§é—®é¢˜,å¦‚æœRediså‘ç”Ÿäº†å®•æœº,é‚£ä¹ˆç¼“å†²åŒºçš„æ•°æ®å°±ä¼šä¸¢å¤±,ä¸ºæ­¤ç³»ç»Ÿæä¾›äº†fsyncå’Œsdatasync2ä¸ªåŒæ­¥å‡½æ•°,å®ƒä»¬å¯ä»¥å¼ºåˆ¶è®©æ“ä½œç³»ç»Ÿç«‹å³å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜ä¸­ Redisçš„AOFé…ç½®é¡¹appendfsyncå†™å›ç­–ç•¥ç›´æ¥å†³å®šäº†æŒä¹…åŒ–åŠŸèƒ½çš„æ•ˆç‡å’Œå®‰å…¨æ€§,ä»¥ä¸‹æ˜¯appendfsyncçš„å…·ä½“é…ç½®\nalways:åŒæ­¥å†™å›,æ¯æ¬¡æ‰§è¡Œå®ŒæŒ‡ä»¤,å°±å°†ç¼“å†²åŒºçš„æ•°æ®å†™å›åˆ°AOFæ–‡ä»¶ä¸­ everysec:æ¯ç§’å†™å›,æ‰§è¡Œå®Œå‘½ä»¤å,å°†æ•°æ®å†™å…¥åˆ°ç¼“å†²åŒº,ç¼“å†²åŒºæ¯éš”ä¸€ç§’å°†æ•°æ®å†™å…¥åˆ°AOFæ–‡ä»¶ no:æ“ä½œç³»ç»Ÿæ§åˆ¶,åœ¨æ‰§è¡Œå®ŒæŒ‡ä»¤å,å°†æ•°æ®å†™å…¥åˆ°ç¼“å†²åŒº,ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å†™å›åˆ°ç£ç›˜ å†™ç£ç›˜ä¼šå¸¦æ¥æ€§èƒ½æŸè€—,è¿™å–å†³äºä½ çš„åº”ç”¨ç¨‹åºå¯¹æ€§èƒ½å’Œæ•°æ®å¯é æ€§çš„å–èˆ\nalways: æ€§èƒ½æœ€å·®,å®‰å…¨æ€§æœ€å¥½,æ•°æ®ä¸ä¼šä¸¢å¤± everysec:å¦‚æœRediså®•æœº,å¯èƒ½ä¼šä¸¢å¤±1ç§’æ—¶é—´å‘¨æœŸçš„æ•°æ®,åœ¨æ€§èƒ½å’Œå¯é æ€§ä¸ŠæŠ˜ä¸­ no:æ€§èƒ½æœ€å¥½,ä½†æœ‰å¯èƒ½ä¸¢å¤±æ›´å¤šæ•°æ® å†™å›ç­–ç•¥çš„é€‰æ‹© ç³»ç»Ÿè¦æ±‚é«˜æ€§èƒ½: é€‰æ‹©noç­–ç•¥ ç³»ç»Ÿè¦æ±‚æ•°æ®é«˜å¯é æ€§:é€‰æ‹©alwaysç­–ç•¥ èƒ½å¤Ÿæ¥æ”¶å°‘é‡æ•°æ®ä¸¢å¤±åˆæƒ³è¦è¾ƒä¸ºè‰¯å¥½çš„æ€§èƒ½:é€‰æ‹©everysecç­–ç•¥(é»˜è®¤ç­–ç•¥å’Œæ¨èç­–ç•¥) æ··åˆRDBå’ŒAOFæ¨¡å¼ æ— è®ºæ˜¯RDBè¿˜æ˜¯AOFæ€»æ˜¯æ„Ÿè§‰ä¸å¤Ÿå°½å–„å°½ç¾,ä½¿ç”¨RDBæ¥æ¢å¤å†…å­˜çŠ¶æ€,åŠ¿å¿…ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®,ä½¿ç”¨AOFæ—¥å¿—æ–‡ä»¶é‡æ”¾å¯¹æ€§èƒ½åˆæœ‰ä¸€å®šå½±å“,å› ä¸ºé‡æ”¾çš„AOFæ—¥å¿—æ–‡ä»¶å¯èƒ½ä¼šå¾ˆå¤§,Redisåœ¨4.0è§£å†³äº†è¿™ä¸ªé—®é¢˜,é‡‡ç”¨ä¸€ç§æ–°çš„æŒä¹…åŒ–æ–¹å¼:æ··åˆæŒä¹…åŒ– è¯¥æ¨¡å¼é»˜è®¤æ˜¯å…³é—­çš„\nå°†RDBæ–‡ä»¶å’Œç”ŸæˆRDBå¿«ç…§æ—¶é—´ç‚¹åçš„AOFå¢é‡æ—¥å¿—å­˜æ”¾åœ¨ä¸€èµ·,è¿™ä¸ªæ—¶å€™AOFæ–‡ä»¶ä¸­å°±ä¸å†æ˜¯æ•´ä¸ªå®ä¾‹çš„å…¨é‡æ—¥å¿—,è€Œæ˜¯æœ€è¿‘ä¸€æ¬¡RDBå¿«ç…§ç‚¹ä¹‹åå‘ç”Ÿçš„å¢é‡æ—¥å¿—,é€šå¸¸è¿™éƒ¨åˆ†AOFæ–‡ä»¶ä¼šå¾ˆå°,æ‰€ä»¥æ‰§è¡Œé¡ºåºå°±å˜æˆå¦‚ä¸‹:\næŸ¥æ‰¾RDBå†…å®¹,å¦‚æœå­˜åœ¨å°±å…ˆåŠ è½½RDBæ–‡ä»¶,ç„¶åå†é‡æ”¾AOFæ—¥å¿—\næ²¡æœ‰RDBæ–‡ä»¶,å°±ç›´æ¥é‡æ”¾AOFæ–‡ä»¶\nè¿™æ ·å¿«ç…§å°±ä¸ç”¨é¢‘ç¹çš„æ‰§è¡Œ,åŒæ—¶ç”±äºAOFæ–‡ä»¶è®°å½•çš„æ˜¯æœ€è¿‘çš„å¿«ç…§ç‚¹ä¹‹åçš„æŒ‡ä»¤,é¿å…äº†å•è¯é‡æ”¾æ—¥å¿—æ–‡ä»¶è¿‡å¤§çš„é—®é¢˜\n","permalink":"https://www.atomicbot.cloud/posts/tech/redis%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E9%AB%98%E5%8F%AF%E7%94%A8/","summary":"ä»‹ç» Redisé€šå¸¸ç”¨æ¥ä½œä¸ºåº”ç”¨ç¨‹åºä¸æ•°æ®åº“DBä¹‹é—´çš„ä¸€å±‚ç¼“å­˜ä¸­é—´ä»¶,æ¥ä¿è¯æ•°æ®çš„è®¿é—®æ•ˆç‡,é‚£æ—¢ç„¶æ˜¯ä¸€å±‚ä¸­é—´ä»¶,å¿…ç„¶å­˜åœ¨å®•æœºã€å´©æºƒçš„é—®é¢˜,ä¸€æ—¦RedisæœåŠ¡ä¸å¯ç”¨,å¯èƒ½äº§ç”Ÿçš„åæœåŒ…æ‹¬: Redisè¿›ç¨‹ä¸­ä¿å­˜çš„æ•°æ®å…¨éƒ¨ä¸¢å¤±,å¼•æ–‡Redisæ•°æ®æ˜¯å­˜åœ¨RAMä¸­çš„ æ•°æ®è®¿é—®ä»å†…å­˜çº§åˆ«é™ä½è‡³IO","title":"Redisçš„æ•°æ®æŒä¹…åŒ–"}]